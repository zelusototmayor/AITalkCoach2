<% content_for :title, @session.title %>

<div class="session-show"
     data-controller="player transcript insights session progress"
     data-session-id-value="<%= @session.id %>"
     data-progress-session-id-value="<%= @session.id %>"
     data-insights-timeframe-value="7d"
     data-insights-show-trends-value="true"
     data-insights-sessions-value="<%= @user_sessions.to_json.html_safe %>"
     data-insights-metrics-value="<%= ['clarity_score', 'wpm', 'filler_rate', 'pace_consistency', 'engagement_score', 'fluency_score', 'overall_score'].to_json.html_safe %>">
  
  <div class="session-header">
    <div class="session-title-section">
      <h1><%= @session.title %></h1>
      <div class="session-meta">
        <span class="language-badge"><%= @session.language.upcase %></span>
        <span class="media-type"><%= @session.media_kind.capitalize %></span>
        <span class="session-date">
          <%= @session.created_at.strftime("%B %d, %Y at %l:%M %p") %>
        </span>
      </div>
    </div>

    <div class="session-actions">
      <%= link_to "‚Üê Back to Sessions", sessions_path, class: "btn btn-secondary" %>
      <div class="action-menu">
        <button type="button" class="btn btn-outline" data-action="click->session#exportSession">
          üìä Export
        </button>
        <button type="button" class="btn btn-outline" data-action="click->session#reprocess">
          üîÑ Reprocess
        </button>
        <%= button_to "üóë Delete", session_path(@session), method: :delete,
              confirm: "Are you sure? This action cannot be undone.",
              class: "btn btn-danger" %>
      </div>
    </div>
  </div>

  <% if @session.processing_state != 'completed' %>
    <div class="processing-status status-<%= @session.processing_state %>" 
         data-progress-target="status">
      <% case @session.processing_state %>
      <% when 'pending' %>
        <div class="status-card">
          <span class="status-icon">‚è≥</span>
          <div class="status-content">
            <h3 data-progress-target="step">Analysis Pending</h3>
            <p data-progress-target="statusText">Your session is queued for processing. This usually takes 1-2 minutes.</p>
            
            <!-- Progress Bar -->
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar" 
                     style="width: 5%" role="progressbar" 
                     aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Starting soon...</span>
              </small>
            </div>
          </div>
        </div>
      <% when 'processing' %>
        <div class="status-card">
          <span class="status-icon">‚ö°</span>
          <div class="status-content">
            <h3 data-progress-target="step">Processing Audio</h3>
            <p data-progress-target="statusText">AI is analyzing your speech patterns, clarity, and providing feedback...</p>
            
            <!-- Progress Bar -->
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar" 
                     style="width: 30%" role="progressbar" 
                     aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Analyzing...</span>
              </small>
            </div>
          </div>
        </div>
      <% when 'failed' %>
        <div class="status-card error">
          <span class="status-icon">‚ùå</span>
          <div class="status-content">
            <h3 data-progress-target="step">Analysis Failed</h3>
            <p data-progress-target="statusText"><%= @session.incomplete_reason || "An unexpected error occurred during processing." %></p>
            <div class="error-actions">
              <button class="btn btn-primary" data-action="click->session#reprocess">
                üîÑ Try Again
              </button>
              <button class="btn btn-secondary" data-action="click->progress#forceRefresh">
                üîÉ Refresh Page
              </button>
              <%= link_to "üéôÔ∏è Record New Session", new_session_path, class: "btn btn-outline" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Show transcript even for failed sessions -->
  <% if @session.processing_state == 'failed' && @session.analysis_data&.dig('transcript').present? %>
    <div class="transcript-section">
      <div class="transcript-header">
        <h3>Transcript (Partial Results)</h3>
        <p class="transcript-note">The audio was successfully transcribed, but analysis failed. You can see the transcript below:</p>
      </div>

      <div class="transcript-content">
        <%= simple_format(@session.analysis_data['transcript']) %>
      </div>
    </div>
  <% end %>

  <% if @session.completed? %>
    <!-- Media Player Section -->
    <div class="media-player-section">
      <div class="player-container">
        <% if @session.media_files.attached? %>
          <% media_file = @session.media_files.first %>
          <% if @session.media_kind == 'video' %>
            <video data-player-target="video" 
                   data-transcript-target="media"
                   controls preload="metadata"
                   class="media-player">
              <%= video_tag media_file, controls: false %>
            </video>
          <% else %>
            <audio data-player-target="audio"
                   data-transcript-target="media"
                   controls preload="metadata"
                   class="media-player">
              <%= audio_tag media_file, controls: false %>
            </audio>
          <% end %>
        <% end %>

        <!-- Issue Markers on Timeline -->
        <div class="timeline-markers" data-player-target="timeline">
          <% @issues.each do |issue| %>
            <button class="issue-marker marker-<%= (issue.category.present? ? issue.category.parameterize : 'uncategorized') %>"
                    data-timestamp="<%= issue.start_ms %>"
                    data-action="click->player#seekTo"
                    title="<%= (issue.category.present? ? issue.category.humanize : 'Uncategorized') %>: <%= truncate(issue.text, length: 50) %>"
                    style="left: <%= (issue.start_ms.to_f / (@session.analysis_data['duration_ms'] || 120000)) * 100 %>%">
            </button>
          <% end %>
        </div>
      </div>

      <!-- Player Controls -->
      <div class="player-controls">
        <button class="control-btn" data-player-target="playBtn" data-action="click->player#togglePlay">
          <span data-player-target="playIcon">‚ñ∂Ô∏è</span>
        </button>
        
        <div class="time-display">
          <span data-player-target="currentTime">00:00</span>
          /
          <span data-player-target="duration">--:--</span>
        </div>

        <div class="playback-speed">
          <label>Speed:</label>
          <select data-player-target="speedSelect" data-action="change->player#changeSpeed">
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
          </select>
        </div>

        <button class="control-btn" data-action="click->player#skipBack" title="Skip back 10s">
          ‚è™
        </button>
        <button class="control-btn" data-action="click->player#skipForward" title="Skip forward 10s">
          ‚è©
        </button>
      </div>
    </div>

    <!-- Analysis Dashboard -->
    <div class="analysis-dashboard">
      <!-- Key Metrics -->
      <div class="metrics-grid">
        <% if @session.analysis_data['wpm'] %>
          <div class="metric-card">
            <div class="metric-value"><%= @session.analysis_data['wpm'].to_i %></div>
            <div class="metric-label">Words/Min</div>
            <div class="metric-context">
              <% wpm = @session.analysis_data['wpm'].to_i %>
              <% if wpm < 140 %>
                <span class="context-slow">Slower pace - good for emphasis</span>
              <% elsif wpm > 180 %>
                <span class="context-fast">Fast pace - ensure clarity</span>
              <% else %>
                <span class="context-good">Natural pace ‚úì</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @session.analysis_data['filler_rate'] %>
          <div class="metric-card">
            <div class="metric-value"><%= (@session.analysis_data['filler_rate'] * 100).round(1) %>%</div>
            <div class="metric-label">Filler Words</div>
            <div class="metric-context">
              <% filler_rate = @session.analysis_data['filler_rate'] %>
              <% if filler_rate < 0.02 %>
                <span class="context-good">Excellent fluency ‚úì</span>
              <% elsif filler_rate > 0.05 %>
                <span class="context-needs-work">Focus on reducing fillers</span>
              <% else %>
                <span class="context-ok">Normal range</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @session.analysis_data['clarity_score'] %>
          <div class="metric-card">
            <div class="metric-value"><%= (@session.analysis_data['clarity_score'] * 100).round %>%</div>
            <div class="metric-label">Clarity Score</div>
            <div class="metric-context">
              <% clarity = @session.analysis_data['clarity_score'] %>
              <% if clarity > 0.8 %>
                <span class="context-good">Very clear ‚úì</span>
              <% elsif clarity < 0.6 %>
                <span class="context-needs-work">Work on enunciation</span>
              <% else %>
                <span class="context-ok">Generally clear</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @session.analysis_data['fluency_score'] %>
          <div class="metric-card">
            <div class="metric-value"><%= @session.analysis_data['fluency_score'].round %>%</div>
            <div class="metric-label">Fluency Score</div>
            <div class="metric-context">
              <% fluency = @session.analysis_data['fluency_score'] %>
              <% if fluency > 80 %>
                <span class="context-good">Excellent flow ‚úì</span>
              <% elsif fluency < 60 %>
                <span class="context-needs-work">Work on smoothness</span>
              <% else %>
                <span class="context-ok">Good flow</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @session.analysis_data['engagement_score'] %>
          <div class="metric-card">
            <div class="metric-value"><%= @session.analysis_data['engagement_score'].round %>%</div>
            <div class="metric-label">Engagement</div>
            <div class="metric-context">
              <% engagement = @session.analysis_data['engagement_score'] %>
              <% if engagement > 75 %>
                <span class="context-good">Very engaging ‚úì</span>
              <% elsif engagement < 50 %>
                <span class="context-needs-work">Add more energy</span>
              <% else %>
                <span class="context-ok">Good energy</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @session.analysis_data['pace_consistency'] %>
          <div class="metric-card">
            <div class="metric-value"><%= @session.analysis_data['pace_consistency'].round %>%</div>
            <div class="metric-label">Pace Consistency</div>
            <div class="metric-context">
              <% consistency = @session.analysis_data['pace_consistency'] %>
              <% if consistency > 80 %>
                <span class="context-good">Very consistent ‚úì</span>
              <% elsif consistency < 60 %>
                <span class="context-needs-work">Vary pace less</span>
              <% else %>
                <span class="context-ok">Generally consistent</span>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="metric-card">
          <div class="metric-value"><%= @issues.count %></div>
          <div class="metric-label">Issues Found</div>
          <div class="metric-context">
            <% if @issues.count == 0 %>
              <span class="context-good">Great job! ‚úì</span>
            <% elsif @issues.count < 5 %>
              <span class="context-ok">Few areas to improve</span>
            <% else %>
              <span class="context-needs-work">Multiple improvement areas</span>
            <% end %>
          </div>
        </div>

        <% if @session.analysis_data['overall_score'] %>
          <div class="metric-card overall-score">
            <div class="metric-value"><%= @session.analysis_data['overall_score'].round %>%</div>
            <div class="metric-label">Overall Score</div>
            <div class="metric-context">
              <% score = @session.analysis_data['overall_score'] %>
              <% if @session.analysis_data['grade'] %>
                <span class="grade-badge grade-<%= @session.analysis_data['grade'].downcase %>">
                  Grade: <%= @session.analysis_data['grade'] %>
                </span>
              <% else %>
                <% if score >= 90 %>
                  <span class="context-good">Excellent performance ‚úì</span>
                <% elsif score >= 75 %>
                  <span class="context-ok">Good performance</span>
                <% else %>
                  <span class="context-needs-work">Room for improvement</span>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Detailed Timing Metrics -->
      <% if @session.analysis_data['duration_seconds'] %>
        <div class="timing-metrics">
          <h3>Session Timing Analysis</h3>
          <div class="timing-grid">
            <div class="timing-card">
              <div class="timing-value"><%= (@session.analysis_data['duration_seconds'] / 60.0).round(1) %>min</div>
              <div class="timing-label">Total Duration</div>
            </div>

            <% if @session.analysis_data['speaking_time_ms'] %>
              <div class="timing-card">
                <div class="timing-value"><%= (@session.analysis_data['speaking_time_ms'] / 60000.0).round(1) %>min</div>
                <div class="timing-label">Speaking Time</div>
              </div>
            <% end %>

            <% if @session.analysis_data['pause_time_ms'] %>
              <div class="timing-card">
                <div class="timing-value"><%= (@session.analysis_data['pause_time_ms'] / 1000.0).round(1) %>s</div>
                <div class="timing-label">Total Pauses</div>
              </div>
            <% end %>

            <% if @session.analysis_data['speech_to_silence_ratio'] %>
              <div class="timing-card">
                <div class="timing-value"><%= @session.analysis_data['speech_to_silence_ratio'].round(1) %>:1</div>
                <div class="timing-label">Speech:Silence</div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Pause Analysis -->
      <% if @session.analysis_data['average_pause_ms'] %>
        <div class="pause-analysis">
          <h3>Pause Quality Analysis</h3>
          <div class="pause-metrics-grid">
            <div class="pause-metric">
              <span class="pause-label">Average Pause:</span>
              <span class="pause-value"><%= (@session.analysis_data['average_pause_ms'] / 1000.0).round(1) %>s</span>
            </div>

            <% if @session.analysis_data['longest_pause_ms'] %>
              <div class="pause-metric">
                <span class="pause-label">Longest Pause:</span>
                <span class="pause-value"><%= (@session.analysis_data['longest_pause_ms'] / 1000.0).round(1) %>s</span>
              </div>
            <% end %>

            <% if @session.analysis_data['long_pause_count'] %>
              <div class="pause-metric">
                <span class="pause-label">Long Pauses (>3s):</span>
                <span class="pause-value"><%= @session.analysis_data['long_pause_count'] %></span>
              </div>
            <% end %>

            <% if @session.analysis_data['pause_quality_score'] %>
              <div class="pause-metric">
                <span class="pause-label">Pause Quality:</span>
                <span class="pause-value"><%= @session.analysis_data['pause_quality_score'].round %>%</span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Issues Breakdown -->
      <% if @issues.any? %>
        <div class="issues-section">
          <h3>Speech Analysis & Feedback</h3>
          
          <div class="issue-categories">
            <% @issues.group_by(&:category).each do |category, category_issues| %>
              <div class="issue-category">
                <div class="category-header">
                  <h4><%= category.humanize.pluralize %> (<%= category_issues.count %>)</h4>
                  <button class="toggle-btn" data-action="click->insights#toggleCategory">
                    <span>Show/Hide</span>
                  </button>
                </div>

                <div class="category-issues">
                  <% category_issues.each do |issue| %>
                    <div class="issue-item" 
                         data-start="<%= issue.start_ms %>"
                         data-end="<%= issue.end_ms %>">
                      <div class="issue-timing">
                        <button class="time-link" 
                                data-action="click->player#seekTo"
                                data-timestamp="<%= issue.start_ms %>">
                          <%= Time.at(issue.start_ms / 1000.0).utc.strftime("%M:%S") %>
                        </button>
                      </div>

                      <div class="issue-content">
                        <div class="issue-text">
                          "<%= issue.text %>"
                        </div>
                        
                        <% if issue.coaching_note.present? %>
                          <div class="coaching-note">
                            <strong>üí° Coach says:</strong> <%= issue.coaching_note %>
                          </div>
                        <% end %>

                        <% if issue.severity %>
                          <div class="issue-severity severity-<%= issue.severity %>">
                            <%= issue.severity.capitalize %> Priority
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="no-issues">
          <div class="success-icon">üéâ</div>
          <h3>Excellent Performance!</h3>
          <p>No major speech issues detected. Your clarity, pace, and fluency are all in good range.</p>
        </div>
      <% end %>
    </div>

    <!-- AI Insights & Coaching Recommendations -->
    <% if @session.analysis_data['ai_insights']&.any? || @session.analysis_data['coaching_recommendations']&.any? %>
      <div class="ai-coaching-section">
        <h3>ü§ñ AI Coach Insights</h3>

        <!-- AI Generated Insights -->
        <% if @session.analysis_data['ai_insights']&.any? %>
          <div class="ai-insights-container">
            <h4>Key Observations</h4>
            <div class="insights-list">
              <% @session.analysis_data['ai_insights'].each do |insight| %>
                <div class="insight-item">
                  <div class="insight-icon">üí°</div>
                  <div class="insight-content">
                    <p><%= insight %></p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Coaching Recommendations -->
        <% if @session.analysis_data['coaching_recommendations'] %>
          <div class="coaching-recommendations">
            <% recommendations = @session.analysis_data['coaching_recommendations'] %>

            <% if recommendations['focus_areas']&.any? %>
              <div class="focus-areas">
                <h4>Focus Areas for Improvement</h4>
                <div class="focus-areas-grid">
                  <% recommendations['focus_areas'].each do |area| %>
                    <div class="focus-area-card">
                      <div class="focus-skill"><%= area['skill']&.humanize || 'General Improvement' %></div>
                      <div class="focus-target"><%= area['target_improvement'] || 'Continue practicing' %></div>
                      <div class="focus-timeline">
                        <small>Timeline: <%= area['timeline'] || '1-2 weeks' %></small>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if recommendations['weekly_goals']&.any? %>
              <div class="weekly-goals">
                <h4>This Week's Goals</h4>
                <div class="goals-list">
                  <% recommendations['weekly_goals'].each do |goal| %>
                    <div class="goal-item">
                      <div class="goal-header">
                        <span class="goal-title"><%= goal['goal'] %></span>
                        <span class="goal-difficulty difficulty-<%= goal['difficulty'] || 'medium' %>">
                          <%= (goal['difficulty'] || 'medium').capitalize %>
                        </span>
                      </div>

                      <% if goal['strategies']&.any? %>
                        <div class="goal-strategies">
                          <strong>Strategies:</strong>
                          <ul>
                            <% goal['strategies'].each do |strategy| %>
                              <li><%= strategy %></li>
                            <% end %>
                          </ul>
                        </div>
                      <% end %>

                      <% if goal['measurement'] %>
                        <div class="goal-measurement">
                          <strong>Track progress:</strong> <%= goal['measurement'] %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if recommendations['motivation_message'] %>
              <div class="motivation-message">
                <div class="motivation-icon">üåü</div>
                <div class="motivation-text">
                  <%= recommendations['motivation_message'] %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Performance Strengths & Areas for Improvement -->
    <% if @session.analysis_data['strengths']&.any? || @session.analysis_data['areas_for_improvement']&.any? %>
      <div class="performance-breakdown">
        <h3>Performance Analysis</h3>

        <div class="performance-grid">
          <% if @session.analysis_data['strengths']&.any? %>
            <div class="strengths-section">
              <h4>üí™ Your Strengths</h4>
              <div class="strengths-list">
                <% @session.analysis_data['strengths'].each do |strength| %>
                  <div class="strength-item">
                    <span class="strength-icon">‚úÖ</span>
                    <span class="strength-text"><%= strength %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @session.analysis_data['areas_for_improvement']&.any? %>
            <div class="improvements-section">
              <h4>üéØ Areas to Work On</h4>
              <div class="improvements-list">
                <% @session.analysis_data['areas_for_improvement'].each do |area| %>
                  <div class="improvement-item">
                    <span class="improvement-icon">üî∏</span>
                    <span class="improvement-text"><%= area %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Component Scores Breakdown -->
    <% if @session.analysis_data['component_scores'] %>
      <div class="component-scores">
        <h3>Detailed Component Scores</h3>
        <div class="component-scores-grid">
          <% @session.analysis_data['component_scores'].each do |component, score| %>
            <div class="component-score-card">
              <div class="component-name"><%= component.to_s.humanize %></div>
              <div class="component-value"><%= score.round %>%</div>
              <div class="component-bar">
                <div class="component-fill" style="width: <%= score %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Insights & Trends Section -->
    <div class="insights-section">
      <div class="insights-header">
        <h3>Progress Insights</h3>
        <div class="insights-controls">
          <select data-insights-target="dateRange"
                  data-action="change->insights#changeTimeframe"
                  class="form-select">
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
          </select>
        </div>
      </div>

      <div class="insights-content">
        <div class="sparklines-grid" data-insights-target="sparkline"></div>
        <div class="trends-section" data-insights-target="trend"></div>
        <div class="ai-insights" data-insights-target="insights"></div>
      </div>
    </div>

    <!-- Transcript Section -->
    <% if @session.analysis_data['transcript'] %>
      <div class="transcript-section">
        <div class="transcript-header">
          <h3>Full Transcript</h3>
          <div class="transcript-controls">
            <input type="search" 
                   placeholder="Search transcript..." 
                   data-transcript-target="searchInput"
                   data-action="input->transcript#search">
            <button class="btn btn-sm" data-action="click->transcript#toggleHighlights">
              Toggle Issue Highlights
            </button>
          </div>
        </div>

        <div class="transcript-content" 
             data-transcript-target="content"
             data-session-id="<%= @session.id %>">
          <%= simple_format(@session.analysis_data['transcript']) %>
        </div>
      </div>
    <% end %>

  <% end %> <!-- End completed check -->

</div>