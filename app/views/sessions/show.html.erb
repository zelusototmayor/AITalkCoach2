<% content_for :title, @session.title %>

<div class="session-show-redesign"
     data-controller="player transcript insights session progress"
     data-action="analytics#handleRealAnalysisView"
     data-session-id-value="<%= @session.id %>"
     data-progress-session-id-value="<%= @session.id %>"
     data-insights-timeframe-value="7d"
     data-insights-show-trends-value="true"
     data-insights-sessions-value="<%= escape_javascript(@user_sessions.to_json) %>"
     data-insights-metrics-value="<%= ['clarity_score', 'wpm', 'filler_rate', 'pace_consistency', 'engagement_score', 'fluency_score', 'overall_score'].to_json.html_safe %>"
     <% if @session.processing_state != 'completed' && @session.processing_state != 'failed' %>
     data-refresh-url="<%= session_path(@session) %>"
     data-auto-refresh="true"
     data-refresh-interval="5000"
     <% end %>>

  <!-- Top Navigation -->
  <div class="analysis-nav">
    <%= link_to practice_path, class: "back-link" do %>
      ← Back to Practice
    <% end %>
    <div class="session-meta-inline">
      <span class="language-badge"><%= @session.language.upcase %></span>
      <span class="media-type"><%= @session.media_kind.capitalize %></span>
      <span class="session-date"><%= @session.created_at.strftime("%b %d, %Y · %l:%M %p") %></span>
    </div>
  </div>

  <!-- Processing Status -->
  <% if @session.processing_state != 'completed' %>
    <% if @session.processing_state == 'failed' %>
      <!-- Show error state with simple UI -->
      <div class="processing-status status-failed">
        <div class="status-card error">
          <span class="status-icon"><%= icon_svg(:x_circle, css_class: 'icon-lg') %></span>
          <div class="status-content">
            <h3>Analysis Failed</h3>
            <p><%= @session.incomplete_reason || "An unexpected error occurred during processing." %></p>
            <div class="error-actions">
              <button class="btn btn-primary" data-action="click->session#reprocess">
                <%= icon_svg(:refresh, css_class: 'icon-inline') %> Try Again
              </button>
              <button class="btn btn-secondary" data-action="click->progress#forceRefresh">
                <%= icon_svg(:refresh, css_class: 'icon-inline') %> Refresh Page
              </button>
              <%= link_to icon_svg(:mic, css_class: 'icon-inline') + " Record New Session", practice_path, class: "btn btn-outline" %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Show enhanced processing UI for pending/processing states -->
      <%= render 'enhanced_processing_status' %>
    <% end %>
  <% end %>

  <!-- Show transcript even for failed sessions -->
  <% if @session.processing_state == 'failed' && @session.analysis_data&.dig('transcript').present? %>
    <div class="transcript-section">
      <div class="transcript-header">
        <h3>Transcript (Partial Results)</h3>
        <p class="transcript-note">The audio was successfully transcribed, but analysis failed. You can see the transcript below:</p>
      </div>
      <div class="transcript-content">
        <%= simple_format(@session.analysis_data['transcript']) %>
      </div>
    </div>
  <% end %>

  <% if @session.completed? %>
    <!-- Session Title -->
    <h1 class="session-title-main">Practice Session #<%= @session.id %> · <%= @session.created_at.strftime("%b %d") %></h1>

    <!-- Media Player Section (MOVED TO TOP) -->
    <div class="media-player-section-top">
      <div class="player-container">
        <% if @session.media_files.attached? %>
          <% media_file = @session.media_files.first %>
          <% if @session.media_kind == 'video' %>
            <video data-player-target="media video"
                   data-transcript-target="media"
                   controls
                   preload="metadata"
                   class="media-player">
              <source src="<%= url_for(media_file) %>" type="<%= media_file.content_type %>">
              Your browser doesn't support video playback.
            </video>
          <% else %>
            <audio data-player-target="media audio"
                   data-transcript-target="media"
                   controls
                   preload="metadata"
                   class="media-player">
              <source src="<%= url_for(media_file) %>" type="<%= media_file.content_type %>">
              Your browser doesn't support audio playback.
            </audio>
          <% end %>
        <% end %>

        <!-- Issue Markers on Timeline -->
        <div class="timeline-markers" data-player-target="timeline">
          <% @issues.each do |issue| %>
            <button class="issue-marker marker-<%= (issue.category.present? ? issue.category.parameterize : 'uncategorized') %>"
                    data-timestamp="<%= issue.start_ms %>"
                    data-action="click->player#seekTo"
                    title="<%= (issue.category.present? ? issue.category.humanize : 'Uncategorized') %>: <%= truncate(issue.text, length: 50) %>"
                    style="left: <%= (issue.start_ms.to_f / (@session.analysis_data['duration_ms'] || 120000)) * 100 %>%">
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Main Content Grid (Metrics + Sidebar) -->
    <div class="analysis-main-grid">
      <!-- Left Column: Main Analysis -->
      <div class="analysis-main-column">
        <!-- 4 Compact Metrics Cards -->
        <div class="metrics-row-compact">
          <% if @session.analysis_data['overall_score']&.present? %>
            <%
              # Fix for overall_score: check if it's already a percentage (>1) or a decimal
              raw_overall_score = @session.analysis_data['overall_score'].to_f
              overall_score_percent = raw_overall_score > 1 ? raw_overall_score : (raw_overall_score * 100)
            %>
            <div class="metric-card-compact highlighted">
              <div class="circular-progress-small"
                   data-controller="circular-progress"
                   data-circular-progress-percentage-value="<%= overall_score_percent %>">
                <svg class="progress-ring" width="80" height="80">
                  <circle class="progress-ring__circle"
                          stroke="#e6f3ff"
                          stroke-width="6"
                          fill="transparent"
                          r="34"
                          cx="40"
                          cy="40"/>
                  <circle class="progress-ring__circle progress-ring__circle--active"
                          stroke="#4F46E5"
                          stroke-width="6"
                          fill="transparent"
                          r="34"
                          cx="40"
                          cy="40"/>
                </svg>
                <div class="progress-percentage-small">
                  <%= overall_score_percent.round %>%
                </div>
              </div>
              <div class="metric-label-compact">
                <%= metric_tooltip("Overall Score", "Your overall performance score based on clarity, pace, fluency, and filler word usage. Scores above 85% are excellent.") %>
              </div>
              <% grade = @session.analysis_data.dig('grade') || 'B+' %>
              <div class="metric-grade-small grade-<%= grade.downcase.gsub(/[^a-z]/, '') %>">
                <%= grade %>
              </div>
            </div>
          <% end %>

          <% if @session.analysis_data['clarity_score']&.present? %>
            <div class="metric-card-compact">
              <div class="circular-progress-small"
                   data-controller="circular-progress"
                   data-circular-progress-percentage-value="<%= normalize_metric_for_display(@session, 'clarity_score') %>">
                <svg class="progress-ring" width="80" height="80">
                  <circle class="progress-ring__circle"
                          stroke="#e6f3ff"
                          stroke-width="6"
                          fill="transparent"
                          r="34"
                          cx="40"
                          cy="40"/>
                  <circle class="progress-ring__circle progress-ring__circle--active"
                          stroke="#4F46E5"
                          stroke-width="6"
                          fill="transparent"
                          r="34"
                          cx="40"
                          cy="40"/>
                </svg>
                <div class="progress-percentage-small">
                  <%= normalize_metric_for_display(@session, 'clarity_score').round %>%
                </div>
              </div>
              <div class="metric-label-compact">
                <%= metric_tooltip("Clarity", "Measures how clearly you articulate words and ideas. Higher scores indicate better pronunciation and comprehension.") %>
              </div>
              <div class="metric-status-compact">
                <% clarity_percent = normalize_metric_for_display(@session, 'clarity_score') %>
                <% if clarity_percent > 85 %>
                  Very clear
                <% elsif clarity_percent > 70 %>
                  Generally clear
                <% else %>
                  Needs improvement
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @session.analysis_data['filler_rate']&.present? %>
            <div class="metric-card-compact">
              <div class="metric-value-compact-large">
                <%= normalize_metric_for_display(@session, 'filler_rate').round(1) %>%
              </div>
              <div class="metric-label-compact">
                <%= metric_tooltip("Filler %", "Percentage of filler words (um, uh, like, you know) in your speech. Target is less than 3% for professional communication.") %>
              </div>
              <div class="metric-status-compact">
                <% filler_rate = normalize_metric_for_display(@session, 'filler_rate') %>
                <% if filler_rate < 3 %>
                  <span style="color: #10b981;">&lt;3% target</span>
                <% else %>
                  &lt;3% target
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @session.analysis_data['wpm']&.present? %>
            <div class="metric-card-compact">
              <div class="metric-value-compact-large">
                <%= @session.analysis_data['wpm'].to_i %> <span class="unit">wpm</span>
              </div>
              <div class="metric-label-compact">
                <%= metric_tooltip("Pace", "Your speaking speed in words per minute (WPM). Optimal pace is 130-150 WPM, acceptable range is 110-170 WPM.") %>
              </div>
              <div class="metric-status-compact">
                <% wpm = @session.analysis_data['wpm'].to_i %>
                <% if wpm >= 130 && wpm <= 150 %>
                  <span style="color: #10b981;">Optimal</span>
                <% elsif wpm >= 110 && wpm < 130 %>
                  <span style="color: #3b82f6;">Slightly slow</span>
                <% elsif wpm > 150 && wpm <= 170 %>
                  <span style="color: #3b82f6;">Slightly fast</span>
                <% elsif wpm < 110 %>
                  <span style="color: #f59e0b;">Too slow</span>
                <% else %>
                  <span style="color: #f59e0b;">Too fast</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Unified Coach Recommendation Section -->
        <%= render 'coach_recommendation' %>

        <!-- Quick Wins Section (Phase 2) -->
        <%= render 'quick_wins' %>

        <!-- What to Fix Section -->
        <div class="issues-section-modern">
          <div class="section-label-small">WHAT TO FIX</div>
          <h2 class="section-heading">Issues</h2>

          <div class="issue-filters-pills">
            <button class="filter-pill active" data-action="click->transcript#filterIssues" data-filter="all">
              All <%= @issues.count %>
            </button>
            <% @issues.group_by(&:category).each do |category, category_issues| %>
              <button class="filter-pill" data-action="click->transcript#filterIssues" data-filter="<%= category %>">
                <%= (category.to_s.present? ? category.to_s : 'uncategorized').humanize %>
                <%= category_issues.count %>
              </button>
            <% end %>
          </div>

          <div class="issues-list-modern">
            <% @issues.limit(10).each do |issue| %>
              <div class="issue-item-modern" data-category="<%= issue.category %>">
                <div class="issue-timestamp-btn">
                  <button class="timestamp-link"
                          data-action="click->player#seekTo"
                          data-timestamp="<%= issue.start_ms %>">
                    <%= Time.at(issue.start_ms / 1000.0).utc.strftime("%M:%S") %>
                  </button>
                </div>
                <div class="issue-content-main">
                  <div class="issue-category-badge">
                    <%= (issue.category.present? ? issue.category.humanize : 'Uncategorized') %>
                  </div>
                  <div class="issue-text-quote">"<%= issue.text %>"</div>
                  <div class="issue-tip">Tip: <%= issue.tip || "Practice pausing instead of using filler words" %></div>
                </div>
                <button class="jump-btn-modern" data-action="click->player#seekTo" data-timestamp="<%= issue.start_ms %>">
                  Jump
                </button>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="analysis-sidebar">
        <!-- Progress vs Last Session -->
        <div class="sidebar-widget">
          <div class="section-label-small">PROGRESS VS LAST SESSION</div>

          <div class="progress-deltas">
            <% if @user_sessions&.is_a?(Array) && @user_sessions.length >= 2 %>
              <%
                current_session = @user_sessions[0]
                previous_session = @user_sessions[1]

                current_clarity = current_session.dig(:metrics, :clarity_score) || current_session.analysis_data&.dig('clarity_score')
                previous_clarity = previous_session.dig(:metrics, :clarity_score) || previous_session.analysis_data&.dig('clarity_score')

                current_filler = current_session.dig(:metrics, :filler_rate) || current_session.analysis_data&.dig('filler_rate')
                previous_filler = previous_session.dig(:metrics, :filler_rate) || previous_session.analysis_data&.dig('filler_rate')

                current_wpm = current_session.dig(:metrics, :wpm) || current_session.analysis_data&.dig('wpm')
                previous_wpm = previous_session.dig(:metrics, :wpm) || previous_session.analysis_data&.dig('wpm')
              %>

              <% if current_clarity && previous_clarity %>
                <div class="delta-row">
                  <span class="delta-label">CLARITY</span>
                  <% delta = ((current_clarity - previous_clarity) * 100).round %>
                  <span class="delta-value <%= delta > 0 ? 'positive' : (delta < 0 ? 'negative' : 'neutral') %>">
                    <%= delta > 0 ? '▲' : (delta < 0 ? '▼' : '→') %> <%= delta.abs %>
                  </span>
                </div>
              <% end %>

              <% if current_filler && previous_filler %>
                <div class="delta-row">
                  <span class="delta-label">FILLER %</span>
                  <% delta = ((current_filler - previous_filler) * 100).round(1) %>
                  <span class="delta-value <%= delta < 0 ? 'positive' : (delta > 0 ? 'negative' : 'neutral') %>">
                    <%= delta < 0 ? '▼' : (delta > 0 ? '▲' : '→') %> <%= delta.abs %>%
                  </span>
                </div>
              <% end %>

              <% if current_wpm && previous_wpm %>
                <div class="delta-row">
                  <span class="delta-label">PACE</span>
                  <% delta = (current_wpm - previous_wpm).round %>
                  <span class="delta-value <%= delta > 0 ? 'positive' : (delta < 0 ? 'negative' : 'neutral') %>">
                    <%= delta > 0 ? '▲' : (delta < 0 ? '▼' : '→') %> <%= delta.abs %>
                  </span>
                </div>
              <% end %>
            <% else %>
              <p class="no-data-text">Complete another session to see progress comparison</p>
            <% end %>
          </div>

        </div>

        <!-- Secondary Insights -->
        <div class="sidebar-widget">
          <div class="section-label-small">SECONDARY INSIGHTS</div>

          <div class="insights-rows">
            <% if @session.analysis_data['pace_consistency']&.present? %>
              <div class="insight-row-simple">
                <span class="insight-label-simple">
                  <%= metric_tooltip("Consistency", "Measures how steady your speaking pace is throughout the session. Higher consistency indicates better rhythm control.") %>
                </span>
                <span class="insight-value-simple"><%= normalize_metric_for_display(@session, 'pace_consistency').round %>%</span>
              </div>
            <% end %>

            <% if @session.analysis_data['longest_pause_ms']&.present? %>
              <div class="insight-row-simple">
                <span class="insight-label-simple">
                  <%= metric_tooltip("Longest pause", "The longest silence in your speech. Strategic pauses (1-2s) are good, but longer pauses may indicate hesitation.") %>
                </span>
                <span class="insight-value-simple"><%= (@session.analysis_data['longest_pause_ms'] / 1000.0).round(1) %>s</span>
              </div>
            <% end %>

            <% if @session.analysis_data['fluency_score']&.present? %>
              <div class="insight-row-simple">
                <span class="insight-label-simple">
                  <%= metric_tooltip("Fluency", "Measures smoothness of delivery without interruptions, hesitations, or excessive pauses. Higher scores indicate more natural flow.") %>
                </span>
                <span class="insight-value-simple"><%= normalize_metric_for_display(@session, 'fluency_score').round %>%</span>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Actions -->
        <div class="sidebar-widget">
          <div class="section-label-small">ACTIONS</div>

          <div class="action-buttons-grid">
            <button class="action-btn" data-action="click->session#share">
              <span class="action-icon"><%= icon_svg(:upload, css_class: 'icon') %></span>
              Share
            </button>
            <button class="action-btn" data-action="click->session#exportSession">
              <span class="action-icon"><%= icon_svg(:download, css_class: 'icon') %></span>
              Export
            </button>
            <button class="action-btn" data-action="click->session#openNotes">
              <span class="action-icon"><%= icon_svg(:file_text, css_class: 'icon') %></span>
              Notes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Full Transcript Section -->
    <% if @session.analysis_data['transcript']&.present? %>
      <div class="transcript-section-modern"
           data-controller="transcript"
           data-transcript-target="section">
        <div class="transcript-header-modern">
          <h2>FULL TRANSCRIPT</h2>
          <button class="toggle-highlights-btn" data-action="click->transcript#toggleHighlights">
            Hide highlights
          </button>
        </div>

        <!-- Color Key Dropdown -->
        <div class="transcript-legend-container">
          <button class="legend-toggle"
                  type="button"
                  data-action="click->transcript#toggleLegend">
            <span>Color Key</span>
            <span class="toggle-icon" data-transcript-target="toggleIcon">▼</span>
          </button>
          <div class="legend-dropdown hidden" data-transcript-target="legend">
            <div class="legend-item">
              <span class="filler-word filler-um">um/uh</span>
              <span class="legend-desc">Critical fillers</span>
            </div>
            <div class="legend-item">
              <span class="filler-word filler-like">like</span>
              <span class="legend-desc">Casual fillers</span>
            </div>
            <div class="legend-item">
              <span class="filler-word filler-you_know">you know</span>
              <span class="legend-desc">Redundant phrases</span>
            </div>
            <div class="legend-item">
              <span class="filler-word filler-basically">basically/actually</span>
              <span class="legend-desc">Weak modifiers</span>
            </div>
          </div>
        </div>

        <div class="transcript-content-modern"
             data-transcript-target="content"
             data-session-id="<%= @session.id %>">
          <% ai_filler_words = @issues.select { |i| i.kind == 'filler_word' && i.source == 'ai' }.map { |i| extract_filler_word(i) }.compact.uniq %>
          <%= highlight_filler_words(@session.analysis_data['transcript'], ai_filler_words) %>
        </div>
      </div>
    <% end %>

  <% end %>
</div>

<script>
  mixpanel.track("Page Viewed", { page: "session_analysis" });
</script>
