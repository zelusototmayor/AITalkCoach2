<% content_for :title, @session.title %>

<div class="session-show-clean"
     data-controller="player transcript insights session progress tabs"
     data-session-id-value="<%= @session.id %>"
     data-progress-session-id-value="<%= @session.id %>"
     data-insights-timeframe-value="7d"
     data-insights-show-trends-value="true"
     data-insights-sessions-value="<%= escape_javascript(@user_sessions.to_json) %>"
     data-insights-metrics-value="<%= ['clarity_score', 'wpm', 'filler_rate', 'pace_consistency', 'engagement_score', 'fluency_score', 'overall_score'].to_json.html_safe %>"
     <% if @session.processing_state != 'completed' && @session.processing_state != 'failed' %>
     data-refresh-url="<%= session_path(@session) %>"
     data-auto-refresh="true"
     data-refresh-interval="5000"
     <% end %>>

  <!-- Session Header -->
  <div class="session-header">
    <div class="session-title-section">
      <h1><%= @session.title %></h1>
      <div class="session-meta">
        <span class="language-badge"><%= @session.language.upcase %></span>
        <span class="media-type"><%= @session.media_kind.capitalize %></span>
        <% if @session.speech_context.present? %>
          <span class="context-badge"><%= @session.speech_context.humanize %></span>
        <% end %>
        <span class="session-date">
          <%= @session.created_at.strftime("%B %d, %Y at %l:%M %p") %>
        </span>
      </div>
    </div>

    <div class="session-actions">
      <%= link_to "‚Üê Back to Sessions", sessions_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <!-- Processing Status -->
  <% if @session.processing_state != 'completed' %>
    <div class="processing-status status-<%= @session.processing_state %>"
         data-progress-target="status">
      <% case @session.processing_state %>
      <% when 'pending' %>
        <div class="status-card">
          <span class="status-icon">‚è≥</span>
          <div class="status-content">
            <h3 data-progress-target="step">Analysis Pending</h3>
            <p data-progress-target="statusText">Your session is queued for processing. This usually takes 1-2 minutes.</p>
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar"
                     style="width: 5%" role="progressbar"
                     aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Starting soon...</span>
              </small>
            </div>
          </div>
        </div>
      <% when 'processing' %>
        <div class="status-card">
          <span class="status-icon">‚ö°</span>
          <div class="status-content">
            <h3 data-progress-target="step">Processing Audio</h3>
            <p data-progress-target="statusText">AI is analyzing your speech patterns, clarity, and providing feedback...</p>
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar"
                     style="width: 30%" role="progressbar"
                     aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Analyzing...</span>
              </small>
            </div>
          </div>
        </div>
      <% when 'failed' %>
        <div class="status-card error">
          <span class="status-icon">‚ùå</span>
          <div class="status-content">
            <h3 data-progress-target="step">Analysis Failed</h3>
            <p data-progress-target="statusText"><%= @session.incomplete_reason || "An unexpected error occurred during processing." %></p>
            <div class="error-actions">
              <button class="btn btn-primary" data-action="click->session#reprocess">
                üîÑ Try Again
              </button>
              <button class="btn btn-secondary" data-action="click->progress#forceRefresh">
                üîÉ Refresh Page
              </button>
              <%= link_to "üéôÔ∏è Record New Session", new_session_path, class: "btn btn-outline" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Show transcript even for failed sessions -->
  <% if @session.processing_state == 'failed' && @session.analysis_data&.dig('transcript').present? %>
    <div class="transcript-section">
      <div class="transcript-header">
        <h3>Transcript (Partial Results)</h3>
        <p class="transcript-note">The audio was successfully transcribed, but analysis failed. You can see the transcript below:</p>
      </div>

      <div class="transcript-content">
        <%= simple_format(@session.analysis_data['transcript']) %>
      </div>
    </div>
  <% end %>

  <% if @session.completed? %>
    <!-- Media Player Section -->
    <div class="media-player-section">
      <div class="player-container">
        <% if @session.media_files.attached? %>
          <% media_file = @session.media_files.first %>
          <% if @session.media_kind == 'video' %>
            <video data-player-target="video"
                   data-transcript-target="media"
                   controls preload="metadata"
                   class="media-player">
              <%= video_tag media_file, controls: false %>
            </video>
          <% else %>
            <audio data-player-target="audio"
                   data-transcript-target="media"
                   controls preload="metadata"
                   class="media-player">
              <%= audio_tag media_file, controls: false %>
            </audio>
          <% end %>
        <% end %>

        <!-- Issue Markers on Timeline -->
        <div class="timeline-markers" data-player-target="timeline">
          <% @issues.each do |issue| %>
            <button class="issue-marker marker-<%= (issue.category.present? ? issue.category.parameterize : 'uncategorized') %>"
                    data-timestamp="<%= issue.start_ms %>"
                    data-action="click->player#seekTo"
                    title="<%= (issue.category.present? ? issue.category.humanize : 'Uncategorized') %>: <%= truncate(issue.text, length: 50) %>"
                    style="left: <%= (issue.start_ms.to_f / (@session.analysis_data['duration_ms'] || 120000)) * 100 %>%">
            </button>
          <% end %>
        </div>
      </div>

    </div>

    <!-- Transcript Section -->
    <% if @session.analysis_data['transcript']&.present? %>
      <div class="transcript-section"
           data-controller="transcript"
           data-transcript-target="section">
        <div class="transcript-header">
          <h3>Full Transcript</h3>
          <div class="transcript-controls">
            <input type="search"
                   placeholder="Search transcript..."
                   data-transcript-target="searchInput"
                   data-action="input->transcript#search">
            <button class="btn btn-sm" data-action="click->transcript#toggleHighlights">
              Toggle Issue Highlights
            </button>
          </div>
        </div>

        <div class="transcript-content"
             data-transcript-target="content"
             data-session-id="<%= @session.id %>">
          <%= highlight_filler_words(@session.analysis_data['transcript']) %>
        </div>
      </div>
    <% else %>
      <div class="no-transcript">
        <p>No transcript available for this session.</p>
      </div>
    <% end %>

    <!-- Tabbed Analysis Interface -->
    <div class="analysis-tabs-container">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tabs-target="tab" data-action="click->tabs#switchTab" data-tab="analysis">Analysis</button>
        <button class="tab-btn" data-tabs-target="tab" data-action="click->tabs#switchTab" data-tab="progress">Progress Plan</button>
      </div>

      <!-- Analysis Tab Content -->
      <div class="tab-content active" data-tabs-target="content" data-tab="analysis">
        <!-- Clean Metrics Overview -->
        <div class="metrics-overview">
          <div class="primary-metrics">
            <% if @session.analysis_data['clarity_score']&.present? %>
              <div class="metric-card-circular primary">
                <div class="circular-progress"
                     data-controller="circular-progress"
                     data-circular-progress-percentage-value="<%= normalize_metric_for_display(@session, 'clarity_score') %>">
                  <svg class="progress-ring" width="120" height="120">
                    <circle class="progress-ring__circle"
                            stroke="#e6f3ff"
                            stroke-width="8"
                            fill="transparent"
                            r="52"
                            cx="60"
                            cy="60"/>
                    <circle class="progress-ring__circle progress-ring__circle--active"
                            stroke="#4F46E5"
                            stroke-width="8"
                            fill="transparent"
                            r="52"
                            cx="60"
                            cy="60"/>
                  </svg>
                  <div class="progress-percentage">
                    <%= normalize_metric_for_display(@session, 'clarity_score').round %>%
                  </div>
                </div>
                <div class="metric-details">
                  <div class="metric-name">CLARITY</div>
                  <div class="metric-description">
                    <% clarity_percent = normalize_metric_for_display(@session, 'clarity_score') %>
                    <% if clarity_percent > 85 %>
                      Very clear
                    <% elsif clarity_percent > 70 %>
                      Generally clear
                    <% else %>
                      Needs improvement
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <div class="secondary-metrics">
            <% if @session.analysis_data['filler_rate']&.present? %>
              <div class="metric-card-simple">
                <div class="metric-header">
                  <span class="metric-indicator filler"></span>
                  <span class="metric-label">Filler %</span>
                </div>
                <div class="metric-value-large"><%= normalize_metric_for_display(@session, 'filler_rate').round(1) %>%</div>
                <div class="metric-target">
                  <% filler_rate = normalize_metric_for_display(@session, 'filler_rate') %>
                  <% if filler_rate < 3 %>
                    Excellent target
                  <% else %>
                    &lt;3% target
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if @session.analysis_data['wpm']&.present? %>
              <div class="metric-card-simple">
                <div class="metric-header">
                  <span class="metric-indicator pace"></span>
                  <span class="metric-label">Pace</span>
                </div>
                <div class="metric-value-large"><%= @session.analysis_data['wpm'].to_i %> wpm</div>
                <div class="metric-target">
                  <% wpm = @session.analysis_data['wpm'].to_i %>
                  <% if wpm >= 140 && wpm <= 180 %>
                    Natural range
                  <% elsif wpm < 140 %>
                    Too slow
                  <% else %>
                    Too fast
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Next Steps Section (Like Coach in screenshot) -->
        <% if @priority_recommendations&.dig(:focus_this_week)&.any? %>
          <div class="next-steps-section">
            <div class="section-header">
              <span class="section-label">NEXT STEP</span>
              <h3>Coach</h3>
            </div>

            <% top_recommendation = @priority_recommendations[:focus_this_week].first %>
            <div class="action-card">
              <div class="action-header">
                <span class="action-label">ACTION</span>
                <button class="re-run-btn">Re-run</button>
              </div>
              <div class="action-title"><%= humanize_improvement_type(top_recommendation[:type]) %></div>
              <div class="action-description">
                <%= top_recommendation[:actionable_steps].first %>
              </div>
              <button class="start-drill-btn">Start 30s Drill</button>
            </div>
          </div>
        <% end %>

        <!-- Issues Section (Clean, like screenshot) -->
        <div class="issues-section-clean">
          <div class="section-header">
            <span class="section-label">WHAT TO FIX</span>
            <h3>Issues</h3>
          </div>

          <div class="issue-filters">
            <div class="filter-tags">
              <button class="filter-tag active" data-action="click->tabs#filterIssues" data-filter="all">
                All <%= @issues.count %>
              </button>
              <% @issues.group_by(&:category).each do |category, category_issues| %>
                <button class="filter-tag" data-action="click->tabs#filterIssues" data-filter="<%= category %>">
                  <%= (category.to_s.present? ? category.to_s : 'uncategorized').humanize %>
                  <%= category_issues.count %>
                </button>
              <% end %>
            </div>
          </div>

          <div class="issues-list-clean">
            <% @issues.limit(5).each do |issue| %>
              <div class="issue-item-clean" data-category="<%= issue.category %>">
                <div class="issue-timestamp">
                  <button class="timestamp-btn"
                          data-action="click->player#seekTo"
                          data-timestamp="<%= issue.start_ms %>">
                    <%= Time.at(issue.start_ms / 1000.0).utc.strftime("%M:%S") %>
                  </button>
                </div>
                <div class="issue-content">
                  <div class="issue-text">"<%= issue.text %>"</div>
                  <div class="issue-priority">
                    <% case issue.severity %>
                    <% when 'high' %>
                      <span class="priority-badge high">High priority</span>
                    <% when 'medium' %>
                      <span class="priority-badge medium">Medium priority</span>
                    <% else %>
                      <span class="priority-badge low">Low priority</span>
                    <% end %>
                  </div>
                </div>
                <button class="jump-btn" data-action="click->player#seekTo" data-timestamp="<%= issue.start_ms %>">Jump</button>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Secondary Insights (Like screenshot) -->
        <div class="secondary-insights">
          <div class="section-header">
            <span class="section-label">CONTEXT</span>
            <h3>Secondary insights</h3>
          </div>

          <div class="insights-grid">
            <% if @session.analysis_data['pace_consistency']&.present? %>
              <div class="insight-row">
                <span class="insight-label">Consistency</span>
                <span class="insight-value"><%= normalize_metric_for_display(@session, 'pace_consistency').round %>%</span>
              </div>
            <% end %>

            <% if @session.analysis_data['longest_pause_ms']&.present? %>
              <div class="insight-row">
                <span class="insight-label">Longest pause</span>
                <span class="insight-value"><%= (@session.analysis_data['longest_pause_ms'] / 1000.0).round(1) %>s</span>
              </div>
            <% end %>

            <% if @session.analysis_data['fluency_score']&.present? %>
              <div class="insight-row">
                <span class="insight-label">Fluency</span>
                <span class="insight-value"><%= normalize_metric_for_display(@session, 'fluency_score').round %>%</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Progress Tab Content -->
      <div class="tab-content" data-tabs-target="content" data-tab="progress">
        <% if @priority_recommendations&.any? %>
          <div class="progress-plan-content">
            <h2>üéØ Your Personalized Improvement Plan</h2>

            <!-- Focus This Week -->
            <% if @priority_recommendations[:focus_this_week]&.any? %>
              <div class="focus-this-week">
                <h3>üî• Focus This Week (High Impact)</h3>
                <div class="focus-areas-grid">
                  <% @priority_recommendations[:focus_this_week].each do |area| %>
                    <div class="focus-area-card priority-<%= area[:severity] %>">
                      <div class="focus-header">
                        <div class="focus-title"><%= humanize_improvement_type(area[:type]) %></div>
                        <div class="focus-metrics">
                          <span class="current-metric">
                            <%= format_metric_value(area[:current_value], area[:type]) %>
                          </span>
                          <span class="arrow">‚Üí</span>
                          <span class="target-metric">
                            <%= format_metric_value(area[:target_value], area[:type]) %>
                          </span>
                        </div>
                      </div>

                      <div class="focus-impact">
                        <span class="impact-score">Impact: +<%= (area[:potential_improvement] * 100).round %>pts</span>
                        <span class="effort-level">Effort: <%= format_effort_level(area[:effort_level]) %></span>
                        <span class="timeline"><%= area[:estimated_weeks] %> weeks</span>
                      </div>

                      <div class="actionable-steps">
                        <strong>Action Steps:</strong>
                        <ul>
                          <% area[:actionable_steps].first(3).each do |step| %>
                            <li><%= step %></li>
                          <% end %>
                        </ul>
                      </div>

                      <% if area[:specific_issues]&.any? %>
                        <div class="specific-examples">
                          <strong>Examples from your speech:</strong>
                          <% area[:specific_issues].first(2).each do |issue| %>
                            <div class="issue-example">
                              <span class="issue-text">"<%= issue[0] %>"</span>
                              <% if issue[1] %>
                                <button class="time-link-small"
                                        data-action="click->player#seekTo"
                                        data-timestamp="<%= issue[1] %>">
                                  <%= Time.at(issue[1] / 1000.0).utc.strftime("%M:%S") %>
                                </button>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- Quick Wins -->
            <% if @priority_recommendations[:quick_wins]&.any? %>
              <div class="quick-wins">
                <h3>‚ö° Quick Wins (Easy Improvements)</h3>
                <div class="quick-wins-list">
                  <% @priority_recommendations[:quick_wins].each do |area| %>
                    <div class="quick-win-item">
                      <div class="quick-win-title"><%= humanize_improvement_type(area[:type]) %></div>
                      <div class="quick-win-description">
                        <% area[:actionable_steps].first(2).each do |step| %>
                          <p>‚Ä¢ <%= step %></p>
                        <% end %>
                      </div>
                      <div class="quick-win-impact">Expected improvement: +<%= (area[:potential_improvement] * 100).round %>pts in <%= area[:estimated_weeks] %> weeks</div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- Practice Plan -->
            <% if @priority_recommendations[:practice_plan]&.any? %>
              <div class="practice-plan">
                <h3>üìÖ Your Daily Practice Plan</h3>

                <div class="practice-sections">
                  <% if @priority_recommendations[:practice_plan][:daily_practice]&.any? %>
                    <div class="daily-practice-section">
                      <h4>Daily Practice (10-15 minutes)</h4>
                      <ul class="practice-list">
                        <% @priority_recommendations[:practice_plan][:daily_practice].each do |practice| %>
                          <li><%= practice %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <% if @priority_recommendations[:practice_plan][:weekly_goals]&.any? %>
                    <div class="weekly-goals-section">
                      <h4>Weekly Goals</h4>
                      <ul class="goals-list">
                        <% @priority_recommendations[:practice_plan][:weekly_goals].each do |goal| %>
                          <li><%= goal %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <% if @priority_recommendations[:practice_plan][:progress_tracking]&.any? %>
                    <div class="progress-tracking-section">
                      <h4>Track Your Progress</h4>
                      <ul class="tracking-list">
                        <% @priority_recommendations[:practice_plan][:progress_tracking].each do |track| %>
                          <li><%= track %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="no-recommendations">
            <h3>üéâ Excellent Performance!</h3>
            <p>No specific improvement areas identified. Keep up the great work!</p>
          </div>
        <% end %>
      </div>

      <!-- Transcript Tab Content -->
    </div>
  <% end %>
</div>