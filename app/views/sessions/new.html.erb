<% content_for :title, "New Session" %>

<div class="session-new" data-controller="recorder prompts" 
     data-recorder-audio-only-value="true"
     data-recorder-max-duration-sec-value="60">
  <div class="page-header">
    <h1>New Recording Session</h1>
    <p>Practice your speaking skills with AI-powered feedback</p>
  </div>

  <%= form_with model: @session, local: true, multipart: true, data: { 
        recorder_target: "form",
        turbo: false 
      } do |f| %>
    
    <div class="session-setup">
      <!-- Recording Interface - Now Primary -->
      <div class="form-section recording-primary">
        <div class="recording-interface">
          <div class="recorder-status" data-recorder-target="status">
            <div class="status-indicator" data-recorder-target="indicator"></div>
            <span class="status-text" data-recorder-target="statusText">Ready to record</span>
          </div>

          <!-- Duration Presets -->
          <div class="duration-presets">
            <h3>Select Duration</h3>
            <div class="preset-buttons">
              <button type="button" class="preset-btn" data-duration="30" data-action="click->recorder#selectDuration">30s</button>
              <button type="button" class="preset-btn" data-duration="45" data-action="click->recorder#selectDuration">45s</button>
              <button type="button" class="preset-btn active" data-duration="60" data-action="click->recorder#selectDuration">60s</button>
              <button type="button" class="preset-btn" data-duration="90" data-action="click->recorder#selectDuration">90s</button>
              <button type="button" class="preset-btn" data-duration="120" data-action="click->recorder#selectDuration">120s</button>
              <button type="button" class="preset-btn" data-duration="300" data-action="click->recorder#selectDuration">300s</button>
            </div>
          </div>

          <div class="recorder-controls">
            <button type="button" class="btn btn-record btn-record-primary" 
                    data-recorder-target="recordBtn"
                    data-action="click->recorder#toggleRecording">
              <span class="btn-icon">üé§</span>
              <span class="btn-text">Start Recording</span>
            </button>

            <div class="recording-timer" data-recorder-target="timer" style="display: none;">
              <div class="countdown-display" data-recorder-target="countdownDisplay">5:00</div>
              <div class="timer-progress">
                <div class="progress-bar" data-recorder-target="progressBar"></div>
              </div>
            </div>
          </div>

          <div class="recording-preview" data-recorder-target="preview" style="display: none;">
            <video data-recorder-target="videoPreview" style="display: none;" controls></video>
            <audio data-recorder-target="audioPreview" style="display: none;" controls></audio>
            
            <div class="preview-actions">
              <button type="button" class="btn btn-secondary"
                      data-action="click->recorder#retake">
                üîÑ Retake
              </button>
              <button type="button" class="btn btn-primary"
                      data-action="click->recorder#submitRecording">
                ‚úì Create Session
              </button>
            </div>
          </div>

          <!-- Hidden file inputs for recorded media -->
          <div style="display: none;">
            <%= f.file_field :media_files, 
                  multiple: true,
                  data: { recorder_target: "fileInput" } %>
          </div>
        </div>
      </div>

      <!-- Prompt Selection -->
      <div class="form-section">
        <h3>Practice Prompts</h3>
        <p>Choose a topic to guide your practice session</p>
        
        <div class="prompt-controls" data-prompts-target="controls">
          <div class="prompt-filters">
            <button type="button" class="filter-btn active" 
                    data-action="click->prompts#filterCategory" 
                    data-category="all">All</button>
            <button type="button" class="filter-btn" 
                    data-action="click->prompts#filterCategory"
                    data-category="presentation">Presentation</button>
            <button type="button" class="filter-btn"
                    data-action="click->prompts#filterCategory" 
                    data-category="interview">Interview</button>
            <button type="button" class="filter-btn"
                    data-action="click->prompts#filterCategory"
                    data-category="conversation">Conversation</button>
          </div>
          
          <button type="button" class="btn btn-secondary"
                  data-action="click->prompts#shufflePrompt">
            üé≤ Random Prompt
          </button>
        </div>

        <div class="selected-prompt" data-prompts-target="selected">
          <!-- Dynamic prompt content will be inserted here by JavaScript -->
        </div>

        <!-- Hidden field to store selected prompt -->
        <input type="hidden" name="selected_prompt_id" data-prompts-target="selectedId">
      </div>

      <!-- Session Configuration - Secondary -->
      <div class="form-section session-config">
        <h3>Session Configuration</h3>
        <div class="form-group">
          <%= f.label :title, class: "form-label" %>
          <%= f.text_field :title, class: "form-input", 
                placeholder: "e.g., Presentation practice, Interview prep" %>
        </div>

        <div class="form-row">
          <div class="form-group">
            <%= f.label :language, class: "form-label" %>
            <%= f.select :language, 
                  options_for_select([
                    ['English', 'en'],
                    ['Portuguese', 'pt'],
                    ['Spanish', 'es']
                  ], 'en'),
                  {}, { class: "form-select" } %>
          </div>

          <div class="form-group">
            <%= f.label :media_kind, "Recording Type", class: "form-label" %>
            <%= f.select :media_kind,
                  options_for_select([
                    ['Audio Only', 'audio'],
                    ['Video', 'video']
                  ], 'audio'),
                  {}, { 
                    class: "form-select",
                    data: { 
                      recorder_target: "mediaKindSelect",
                      action: "change->recorder#updateMediaKind"
                    }
                  } %>
          </div>
        </div>
        
        <!-- Hidden duration field -->
        <%= f.hidden_field :target_seconds, value: 60, data: { recorder_target: "durationInput" } %>
      </div>

      <div class="form-actions">
        <% if @session.errors.any? %>
          <div class="form-errors">
            <h4><%= pluralize(@session.errors.count, "error") %> prohibited this session from being saved:</h4>
            <ul>
              <% @session.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= link_to "Cancel", sessions_path, class: "btn btn-secondary" %>
        <%= f.submit "Create Session", class: "btn btn-primary", 
              data: { recorder_target: "submitBtn" }, style: "display: none;" %>
      </div>
    </div>
  <% end %>

  <!-- Recording Tips -->
  <div class="recording-tips">
    <h3>üìù Recording Tips</h3>
    <ul>
      <li>Find a quiet environment with minimal background noise</li>
      <li>Speak clearly and at a normal pace</li>
      <li>Position yourself about arm's length from your device</li>
      <li>For video: ensure good lighting and look at the camera</li>
      <li>Take your time - you can always re-record</li>
    </ul>
  </div>
</div>

<script type="application/json" id="prompts-data">
<%= raw @prompts.to_json %>
</script>
<script type="application/json" id="categories-data">
<%= raw @categories.to_json %>
</script>