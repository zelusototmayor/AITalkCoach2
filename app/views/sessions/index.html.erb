<% content_for :title, "Practice" %>

<div class="practice-interface"
     data-controller="recorder prompts insights practice-timer"
     data-recorder-audio-only-value="true"
     data-recorder-max-duration-sec-value="180"
     data-practice-timer-default-duration-value="60">

  <div class="practice-layout">
    <!-- Left Panel - Practice Interface -->
    <div class="practice-panel">
      <div class="practice-header">
        <h2>Practice Session</h2>
      </div>

      <!-- Current Prompt Display -->
      <div class="prompt-display" data-prompts-target="display">
        <div class="prompt-header">
          <h4>Current Prompt</h4>
          <div class="prompt-actions">
            <span class="prompt-target-time" data-prompts-target="targetTime">~<%= @default_prompt_data[:target_seconds] %>s</span>
            <button type="button" class="shuffle-btn"
                    data-action="click->prompts#shufflePrompt"
                    title="Get a random prompt">
              Shuffle
            </button>
          </div>
        </div>
        <div class="prompt-content" data-prompts-target="content">
          <p><%= @default_prompt %></p>
        </div>
      </div>

      <!-- Timer Controls - Compact Layout -->
      <div class="timer-controls-compact">
        <div class="timer-header">
          <h5>Duration</h5>
          <div class="preset-buttons-horizontal">
            <button type="button" class="preset-btn"
                    data-duration="30"
                    data-action="click->practice-timer#selectDuration">30s</button>
            <button type="button" class="preset-btn active"
                    data-duration="60"
                    data-action="click->practice-timer#selectDuration">60s</button>
            <button type="button" class="preset-btn"
                    data-duration="120"
                    data-action="click->practice-timer#selectDuration">120s</button>
            <button type="button" class="preset-btn"
                    data-duration="180"
                    data-action="click->practice-timer#selectDuration">180s</button>
          </div>
        </div>

        <div class="timer-start-layout">
          <button type="button" class="start-btn-compact"
                  data-practice-timer-target="startBtn"
                  data-action="click->practice-timer#startSession">
            ▶ Start <span data-practice-timer-target="durationText">60s</span>
          </button>

          <div class="countdown-timer-compact" data-practice-timer-target="display">
            <div class="timer-circle-small">
              <svg class="timer-svg" viewBox="0 0 80 80">
                <circle class="timer-track" cx="40" cy="40" r="36"></circle>
                <circle class="timer-progress"
                        cx="40" cy="40" r="36"
                        data-practice-timer-target="progressCircle"></circle>
              </svg>
              <div class="timer-content">
                <div class="timer-percentage" data-practice-timer-target="percentage">0%</div>
                <div class="timer-status" data-practice-timer-target="status">Ready</div>
              </div>
            </div>
            <div class="timer-time" data-practice-timer-target="timeDisplay">0s / 60s</div>
          </div>
        </div>
      </div>

      <!-- Enforcement Notice -->
      <div class="enforcement-notice">
        <p><small>Minimum time is enforced. Stopping early will mark the session as incomplete.</small></p>
      </div>

      <!-- Streamlined Pre-Recording Setup -->
      <div class="pre-recording-setup-compact" data-practice-timer-target="setup">
        <div class="session-config-compact">
          <div class="config-row">
            <div class="config-group">
              <label class="config-label">Session Title</label>
              <input type="text" class="config-input"
                     placeholder="e.g., Interview practice"
                     data-recorder-target="titleInput"
                     data-action="input->recorder#clearTitleError"
                     required>
              <div class="field-error" data-recorder-target="titleError" style="display: none;"></div>
            </div>
          </div>

          <div class="config-row secondary-settings">
            <div class="config-group">
              <label class="config-label">Language</label>
              <select class="config-select" data-recorder-target="languageSelect">
                <option value="en">English</option>
                <option value="pt">Portuguese</option>
                <option value="es">Spanish</option>
              </select>
            </div>
            <div class="config-group">
              <label class="config-label">Type</label>
              <select class="config-select" data-recorder-target="mediaKindSelect">
                <option value="audio">Audio</option>
                <option value="video">Video</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Post-Recording Form (appears after recording) -->
      <div class="recording-preview" data-recorder-target="preview" style="display: none;">
        <h5>Recording Complete!</h5>
        <div class="completion-message">
          <p>Your recording is ready. Review the details below and submit when ready.</p>
        </div>
        <div class="session-details-form">
          <div class="form-group">
            <label class="form-label">Session Title *</label>
            <input type="text" class="form-input session-title-input"
                   placeholder="e.g., Presentation practice, Interview prep"
                   data-recorder-target="titleInputPreview"
                   data-action="input->recorder#clearTitleError"
                   readonly>
            <small class="field-help">Copied from your pre-recording setup</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Language</label>
              <select class="form-select" data-recorder-target="languageSelectPreview" disabled>
                <option value="en">English</option>
                <option value="pt">Portuguese</option>
                <option value="es">Spanish</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Recording Type</label>
              <select class="form-select" data-recorder-target="mediaKindSelectPreview" disabled>
                <option value="audio">Audio Only</option>
                <option value="video">Video</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Audio Preview -->
        <div class="audio-preview">
          <audio data-recorder-target="audioPreview" controls></audio>
        </div>

        <!-- Action Buttons -->
        <div class="preview-actions">
          <button type="button" class="btn btn-secondary btn-replay"
                  data-action="click->recorder#replayAudio">
            Replay
          </button>
          <button type="button" class="btn btn-primary btn-use-recording"
                  data-action="click->recorder#submitRecording">
            Upload & Analyze
          </button>
        </div>
      </div>

      <!-- Session Report (appears after completion) -->
      <div class="session-report" data-practice-timer-target="report" style="display: none;">
        <h5>Session Report</h5>
        <div class="report-content">
          <!-- Will be populated by JavaScript after session completion -->
        </div>
      </div>
    </div>

    <!-- Right Panel - Insights & Library -->
    <div class="insights-panel">
      <!-- Key Insights Header (Similar to screenshot) -->
      <div class="insights-header-card">
        <h3>📊 Insights</h3>
        <div class="key-metrics-row">
          <div class="key-metric">
            <div class="metric-label">AVG WPM</div>
            <div class="metric-value-large">
              <%= @quick_metrics[:avg_wpm] || 0 %>
            </div>
          </div>
          <div class="key-metric">
            <div class="metric-label">FILLER %</div>
            <div class="metric-value-large">
              <%= @quick_metrics[:filler_rate] || 0 %>%
            </div>
          </div>
        </div>
        <div class="key-metrics-row secondary-row">
          <div class="key-metric">
            <div class="metric-label">CLARITY</div>
            <div class="metric-value-large">
              <%= @quick_metrics[:clarity_score] || 0 %>
            </div>
          </div>
          <div class="key-metric">
            <div class="metric-label">STREAK</div>
            <div class="metric-value-large">
              <%= @current_streak %> days
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Performance Metrics -->
      <div class="performance-metrics-card">
        <h4>Performance Metrics</h4>
        <div class="metrics-grid-enhanced">
          <div class="metric-item">
            <div class="metric-label">Sessions</div>
            <div class="metric-value">
              <%= @recent_sessions.count %>
            </div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Total Time</div>
            <div class="metric-value">
              <%= (@recent_sessions.sum { |s| s.duration_seconds || 0 } / 60).round %>m
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Sessions Quick Access -->
      <% if @recent_sessions.any? %>
        <div class="recent-sessions-card">
          <h5>Recent Sessions</h5>
          <div class="recent-sessions-list">
            <% @recent_sessions.first(3).each do |session| %>
              <div class="recent-session-item">
                <a href="<%= session_path(session) %>" class="session-link">
                  <div class="session-title"><%= session.title.truncate(25) %></div>
                  <div class="session-meta">
                    <%= time_ago_in_words(session.created_at) %> ago
                    <span class="session-duration">
                      <%= session.duration_seconds ? "#{(session.duration_seconds / 60.0).round(1)}m" : "N/A" %>
                    </span>
                  </div>
                </a>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Focus Areas -->
      <% if @focus_areas.any? %>
        <div class="focus-areas-card">
          <h5>Focus Areas</h5>
          <ul class="focus-list">
            <% @focus_areas.each do |area| %>
              <li>• <%= area %></li>
            <% end %>
          </ul>
        </div>
      <% end %>


      <!-- Prompt Library (Enhanced to match screenshot) -->
      <div class="prompt-library-card">
        <h4>⭐ Prompt Library</h4>

        <div class="library-tabs">
          <button type="button" class="tab-btn active"
                  data-action="click->prompts#selectCategory"
                  data-category="any">Any</button>
          <button type="button" class="tab-btn"
                  data-action="click->prompts#selectCategory"
                  data-category="interviews">Interviews</button>
          <button type="button" class="tab-btn"
                  data-action="click->prompts#selectCategory"
                  data-category="pitching">Pitching</button>
          <button type="button" class="tab-btn"
                  data-action="click->prompts#selectCategory"
                  data-category="story">Story</button>
        </div>

        <div class="library-content">
          <div class="fluency-section">
            <h5>Fluency</h5>
            <div class="prompt-list" data-prompts-target="library">
              <!-- Featured prompts with Use buttons -->
              <div class="prompt-item featured" data-category="interviews">
                <div class="prompt-text">Tell me about a time you influenced a decision without authority.</div>
                <button type="button" class="use-btn primary"
                        data-action="click->prompts#usePrompt"
                        data-prompt="Tell me about a time you influenced a decision without authority.">Use</button>
              </div>

              <div class="prompt-item featured" data-category="pitching">
                <div class="prompt-text">Explain your startup to a 10-year-old in 30s.</div>
                <button type="button" class="use-btn primary"
                        data-action="click->prompts#usePrompt"
                        data-prompt="Explain your startup to a 10-year-old in 30s.">Use</button>
              </div>

              <div class="prompt-item featured" data-category="story">
                <div class="prompt-text">Describe a failure that changed your perspective.</div>
                <button type="button" class="use-btn primary"
                        data-action="click->prompts#usePrompt"
                        data-prompt="Describe a failure that changed your perspective.">Use</button>
              </div>

              <!-- Dynamic prompts from configuration -->
              <% @prompts.each do |category, prompts_list| %>
                <% next unless prompts_list.is_a?(Array) %>
                <% prompts_list.first(2).each do |prompt| %>
                  <div class="prompt-item" data-category="<%= category.downcase %>">
                    <div class="prompt-text">
                      <% if prompt.is_a?(Hash) %>
                        <%= prompt['prompt'] %>
                      <% else %>
                        <%= prompt %>
                      <% end %>
                    </div>
                    <button type="button" class="use-btn"
                            data-action="click->prompts#usePrompt"
                            data-prompt="<%= prompt.is_a?(Hash) ? prompt['prompt'] : prompt %>">Use</button>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Elevator Pitch section -->
          <div class="elevator-pitch-section">
            <h5>Elevator Pitch</h5>
            <div class="prompt-list">
              <div class="prompt-item featured" data-category="pitching">
                <div class="prompt-text">Imagine you are in an elevator with someone who could fund your project. You have 30 seconds to explain what you are working on and why it matters.</div>
                <button type="button" class="use-btn primary"
                        data-action="click->prompts#usePrompt"
                        data-prompt="Imagine you are in an elevator with someone who could fund your project. You have 30 seconds to explain what you are working on and why it matters.">Use</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden form for session creation -->
  <%= form_with model: Session.new, local: true, multipart: true, class: "hidden-form",
        data: { practice_timer_target: "form", turbo: false } do |f| %>
    <%= f.hidden_field :title, data: { practice_timer_target: "titleInput" } %>
    <%= f.hidden_field :language, value: "en" %>
    <%= f.hidden_field :media_kind, value: "audio" %>
    <%= f.hidden_field :target_seconds, data: { practice_timer_target: "durationInput" } %>
    <%= f.hidden_field :minimum_duration_enforced, value: "true" %>
    <%= f.file_field :media_files, multiple: true,
          data: { recorder_target: "fileInput" }, style: "display: none;" %>
    <%= f.submit "Create Session", data: { practice_timer_target: "submitBtn" },
          style: "display: none;" %>
  <% end %>
</div>

<!-- Data for JavaScript controllers -->
<script type="application/json" id="prompts-data">
<%= raw @prompts.to_json %>
</script>

<script type="application/json" id="adaptive-prompts-data">
<%= raw @adaptive_prompts.to_json %>
</script>

<script type="application/json" id="categories-data">
<%= raw @categories.to_json %>
</script>