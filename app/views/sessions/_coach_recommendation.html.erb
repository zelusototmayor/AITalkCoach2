<% if @priority_recommendations&.dig(:focus_this_week)&.any? %>
  <div class="coach-recommendation-section">
    <div class="section-label-small">COACH RECOMMENDATION</div>
    <h2 class="section-heading"><%= icon_svg(:target, css_class: 'icon-inline') %> Next Step</h2>

    <% top_recommendation = @priority_recommendations[:focus_this_week].first %>

    <% if top_recommendation[:type] == 'record_again_for_baseline' %>
      <!-- First session: prompt to record again for baseline -->
      <div class="coach-card first-session-card">
        <div class="coach-card-badge welcome-badge">WELCOME ðŸ‘‹</div>
        <h3 class="coach-card-title">Great First Session!</h3>
        <p class="coach-card-description">
          <%= top_recommendation[:actionable_steps].first %>
        </p>
        <%= link_to practice_path, class: "coach-btn-primary" do %>
          <%= icon_svg(:mic, css_class: 'icon-inline') %> Record Another Session
        <% end %>
      </div>

    <% elsif @recommendation_matches_focus && @weekly_focus %>
      <!-- Matched with weekly focus: show progress and continuity -->
      <div class="coach-card matched-focus-card">
        <div class="coach-card-badge action-badge">KEEP GOING ðŸ’ª</div>
        <h3 class="coach-card-title">
          <%= humanize_improvement_type(top_recommendation[:type]) %>
        </h3>
        <p class="coach-card-description">
          <%= top_recommendation[:actionable_steps].first %>
        </p>

        <!-- Weekly progress bar -->
        <div class="weekly-progress-container">
          <div class="weekly-progress-header">
            <span class="progress-label">This Week's Progress</span>
            <span class="progress-count"><%= @weekly_progress[:completed] %>/<%= @weekly_progress[:target] %> sessions</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" style="width: <%= @weekly_progress[:percentage] %>%"></div>
          </div>
        </div>

        <div class="coach-actions">
          <button class="coach-btn-primary"
                  data-action="click->session#startDrill"
                  data-session-type-param="<%= top_recommendation[:type] %>"
                  data-session-duration-param="60">
            <%= icon_svg(:mic, css_class: 'icon-inline') %> Continue Practice (60s)
          </button>
          <%= link_to progress_path, class: "coach-btn-secondary" do %>
            <%= icon_svg(:chart_bar, css_class: 'icon-inline') %> View Full Plan
          <% end %>
        </div>
      </div>

    <% elsif @weekly_focus %>
      <!-- Has weekly focus but recommendation differs: offer to switch -->
      <div class="coach-card switch-focus-card">
        <div class="coach-card-badge insight-badge">NEW INSIGHT ðŸ’¡</div>
        <h3 class="coach-card-title">
          Consider: <%= humanize_improvement_type(top_recommendation[:type]) %>
        </h3>
        <p class="coach-card-description">
          Based on this session, I noticed: <%= top_recommendation[:actionable_steps].first %>
        </p>
        <p class="coach-card-note">
          <strong>Current weekly focus:</strong> <%= humanize_improvement_type(@weekly_focus.focus_type) %>
        </p>

        <div class="coach-actions">
          <button class="coach-btn-primary"
                  data-action="click->session#startDrill"
                  data-session-type-param="<%= top_recommendation[:type] %>"
                  data-session-duration-param="30">
            <%= icon_svg(:mic, css_class: 'icon-inline') %> Try This Drill (30s)
          </button>
          <button class="coach-btn-secondary"
                  data-action="click->session#switchWeeklyFocus"
                  data-session-recommendation-param="<%= top_recommendation[:type] %>">
            <%= icon_svg(:refresh, css_class: 'icon-inline') %> Switch Weekly Focus
          </button>
        </div>
      </div>

    <% else %>
      <!-- No weekly focus: show recommendation with option to set as focus -->
      <div class="coach-card new-recommendation-card">
        <div class="coach-card-badge action-badge">RECOMMENDED ðŸŽ¯</div>
        <h3 class="coach-card-title">
          <%= humanize_improvement_type(top_recommendation[:type]) %>
        </h3>
        <p class="coach-card-description">
          <%= top_recommendation[:actionable_steps].first %>
        </p>

        <!-- Show current vs target metrics if available -->
        <% if top_recommendation[:current_value] && top_recommendation[:target_value] %>
          <div class="metric-comparison">
            <div class="metric-item">
              <span class="metric-label">Current</span>
              <span class="metric-value"><%= format_metric_value(top_recommendation[:current_value], top_recommendation[:type]) %></span>
            </div>
            <span class="metric-arrow">â†’</span>
            <div class="metric-item">
              <span class="metric-label">Target</span>
              <span class="metric-value target"><%= format_metric_value(top_recommendation[:target_value], top_recommendation[:type]) %></span>
            </div>
          </div>
        <% end %>

        <div class="coach-actions">
          <button class="coach-btn-primary"
                  data-action="click->session#startDrill"
                  data-session-type-param="<%= top_recommendation[:type] %>"
                  data-session-duration-param="30">
            <%= icon_svg(:mic, css_class: 'icon-inline') %> Try This Drill (30s)
          </button>
          <button class="coach-btn-secondary"
                  data-action="click->session#setAsWeeklyFocus"
                  data-session-recommendation-param="<%= top_recommendation[:type] %>">
            <%= icon_svg(:calendar, css_class: 'icon-inline') %> Set as Weekly Focus
          </button>
        </div>
      </div>
    <% end %>
  </div>

  <style>
    .coach-recommendation-section {
      margin: 2rem 0;
    }

    .coach-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 2rem;
      margin-top: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .coach-card:hover {
      border-color: #4F46E5;
      box-shadow: 0 8px 24px rgba(79, 70, 229, 0.15);
    }

    .matched-focus-card {
      border-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
    }

    .matched-focus-card:hover {
      border-color: #059669;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
    }

    .coach-card-badge {
      display: inline-block;
      padding: 0.375rem 0.875rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }

    .welcome-badge {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    .action-badge {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
    }

    .insight-badge {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      color: #9f1239;
    }

    .coach-card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 1rem 0;
      line-height: 1.3;
    }

    .coach-card-description {
      font-size: 1.0625rem;
      color: #475569;
      line-height: 1.7;
      margin: 0 0 1.5rem 0;
    }

    .coach-card-note {
      padding: 1rem;
      background: #f8fafc;
      border-left: 3px solid #cbd5e1;
      border-radius: 6px;
      font-size: 0.9375rem;
      color: #64748b;
      margin-bottom: 1.5rem;
    }

    .coach-card-note strong {
      color: #1e293b;
    }

    .weekly-progress-container {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .weekly-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .progress-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .progress-count {
      font-size: 0.9375rem;
      font-weight: 700;
      color: #10b981;
    }

    .progress-bar-bg {
      height: 12px;
      background: #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .metric-comparison {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      padding: 1.25rem;
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }

    .metric-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
    }

    .metric-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }

    .metric-value.target {
      color: #10b981;
    }

    .metric-arrow {
      font-size: 1.5rem;
      color: #cbd5e1;
    }

    .coach-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .coach-btn-primary {
      flex: 1;
      background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
      color: white;
      border: none;
      padding: 0.875rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .coach-btn-primary:hover {
      background: linear-gradient(135deg, #4338CA 0%, #4F46E5 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
    }

    .coach-btn-primary:active {
      transform: translateY(0);
    }

    .coach-btn-secondary {
      flex: 1;
      background: white;
      color: #4F46E5;
      border: 2px solid #e2e8f0;
      padding: 0.875rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .coach-btn-secondary:hover {
      background: #f8fafc;
      border-color: #4F46E5;
      color: #4338CA;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .coach-card {
        padding: 1.5rem;
      }

      .coach-card-title {
        font-size: 1.25rem;
      }

      .coach-actions {
        flex-direction: column;
      }

      .metric-comparison {
        gap: 1rem;
      }
    }
  </style>
<% end %>
