<% content_for :title, "Your Progress" %>

<div class="progress-page" data-controller="progress-dashboard">
  <div class="page-header">
    <h1>Your Progress</h1>
    <p class="page-subtitle">A focused plan you can complete today.</p>
  </div>

  <% if @recent_sessions.any? %>
    <div class="progress-dashboard">
      <!-- Left Column -->
      <div class="progress-left-column">
        <!-- Weekly Focus Section -->
        <div class="weekly-focus-card">
          <div class="card-header">
            <h3>WEEKLY FOCUS</h3>
            <span class="estimated-time">Est. time<br>6–8 min / day</span>
          </div>

          <% if @priority_recommendations&.dig(:focus_this_week)&.first %>
            <% focus_area = @priority_recommendations[:focus_this_week].first %>

            <div class="focus-title">
              <span class="focus-icon"><%= icon_svg(:fire, css_class: 'icon-inline') %></span>
              <h2><%= humanize_improvement_type(focus_area[:type]) %></h2>
            </div>

            <div class="focus-target">
              Target ≤ <%= format_metric_value(focus_area[:target_value], focus_area[:type]) %> by Sunday.
              Average last 5 sessions: <%= format_metric_value(focus_area[:current_value], focus_area[:type]) %>.
            </div>

            <div class="focus-progress-grid">
              <div class="progress-item">
                <div class="progress-label">Today</div>
                <div class="progress-value">
                  <%= @weekly_focus_tracking ? "#{@weekly_focus_tracking[:sessions_today]} / #{@weekly_focus_tracking[:target_today]} drills" : "0 / 2 drills" %>
                </div>
              </div>
              <div class="progress-item">
                <div class="progress-label">Week</div>
                <div class="progress-value">
                  <%= @weekly_focus_tracking ? "#{@weekly_focus_tracking[:sessions_this_week]} / #{@weekly_focus_tracking[:target_this_week]} drills" : "0 / 10 drills" %>
                </div>
              </div>
              <div class="progress-item">
                <div class="progress-label">Streak</div>
                <div class="progress-value">
                  <%= @weekly_focus_tracking ? "#{@weekly_focus_tracking[:streak_days]} day#{'s' unless @weekly_focus_tracking[:streak_days] == 1}" : "0 days" %>
                </div>
              </div>
            </div>

            <div class="focus-actions">
              <% if @daily_plan && @daily_plan[:drills].present? %>
                <%= link_to icon_from_emoji(@daily_plan[:drills].first[:icon]) + " #{@daily_plan[:drills].first[:title]}",
                    practice_path(
                      weekly_focus_id: @weekly_focus&.id,
                      is_planned_session: true,
                      drill_title: @daily_plan[:drills].first[:title],
                      target_seconds: @daily_plan[:drills].first[:duration_seconds]
                    ),
                    class: "btn btn-primary" %>
                <% if @daily_plan[:drills].length > 1 %>
                  <%= link_to icon_from_emoji(@daily_plan[:drills][1][:icon]) + " #{@daily_plan[:drills][1][:title]}",
                      practice_path(
                        weekly_focus_id: @weekly_focus&.id,
                        is_planned_session: true,
                        drill_title: @daily_plan[:drills][1][:title],
                        target_seconds: @daily_plan[:drills][1][:duration_seconds]
                      ),
                      class: "btn btn-secondary" %>
                <% end %>
              <% else %>
                <%= link_to icon_svg(:mic, css_class: 'icon-inline') + " Start Practice", practice_path, class: "btn btn-primary" %>
              <% end %>
            </div>

            <div class="coach-tip">
              <strong>Coach tip</strong>
              <p><%= focus_area[:actionable_steps]&.first || "Practice daily for best results" %></p>
            </div>
          <% else %>
            <div class="no-focus">
              <p>Complete more sessions to get personalized weekly focus recommendations.</p>
              <%= link_to "Start Practicing", practice_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>

        <!-- Today's 10-Minute Plan -->
        <div class="daily-plan-card">
          <div class="card-header">
            <h3>TODAY'S <%= @daily_plan ? "#{@daily_plan[:total_duration_minutes]}-MINUTE" : "10-MINUTE" %> PLAN</h3>
          </div>

          <% if @daily_plan && @daily_plan[:drills].present? %>
            <div class="plan-items">
              <% @daily_plan[:drills].each do |drill| %>
                <div class="plan-item">
                  <div class="plan-number"><%= drill[:order] %></div>
                  <div class="plan-content">
                    <h4><%= icon_from_emoji(drill[:icon]) %> <%= drill[:title] %></h4>
                    <p><%= drill[:description] %></p>
                  </div>
                  <%= link_to practice_path(
                    weekly_focus_id: drill[:weekly_focus_id],
                    is_planned_session: true,
                    drill_title: drill[:title],
                    target_seconds: drill[:duration_seconds]
                  ), class: "btn-start", method: :get do %>
                    ⭐ Start
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="plan-actions">
              <%= link_to icon_svg(:star, css_class: 'icon-inline') + " Start Plan", practice_path(
                weekly_focus_id: @weekly_focus&.id,
                is_planned_session: true,
                drill_title: @daily_plan[:drills].first[:title],
                target_seconds: @daily_plan[:drills].first[:duration_seconds]
              ), class: "btn btn-primary" %>
              <%= button_tag "Customize", class: "btn btn-link", disabled: true %>
            </div>
          <% else %>
            <div class="plan-items">
              <div class="plan-item">
                <div class="plan-number">1</div>
                <div class="plan-content">
                  <h4>Complete More Sessions</h4>
                  <p>Record a few more practice sessions to get personalized daily plans.</p>
                </div>
                <%= link_to practice_path, class: "btn-start" do %>
                  <%= icon_svg(:star, css_class: 'icon-inline') %> Start
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Practice Calendar -->
        <div class="practice-calendar-card">
          <div class="card-header">
            <h3>PRACTICE CALENDAR</h3>
          </div>

          <% if @calendar_data.present? %>
            <div class="calendar-grid">
              <% @calendar_data.each do |day| %>
                <div class="calendar-day <%= day[:has_session] ? 'trained' : 'missed' %>"
                     title="<%= day[:date].strftime('%b %d, %Y') %>">
                </div>
              <% end %>
            </div>

            <div class="calendar-legend">
              <div class="legend-item">
                <div class="legend-dot missed"></div>
                <span>Missed day</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot trained"></div>
                <span>Trained</span>
              </div>
            </div>

            <div class="calendar-note">
              Each filled square = a completed practice day. Keep the streak alive.
            </div>
          <% end %>
        </div>

        <!-- Skill Snapshot -->
        <div class="skill-snapshot-card">
          <div class="card-header">
            <h3>SKILL SNAPSHOT
              <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide" style="font-size: 12px; margin-left: 4px; cursor: help;">
                <%= icon_svg(:info, css_class: 'icon-inline') %>
                <span data-tooltip-target="content" class="tooltip-content hidden" style="width: 280px;">
                  Shows your recent trend by comparing the average of your last 5 sessions to your overall 30-day average. Green arrows indicate improvement.
                </span>
              </span>
            </h3>
            <p class="card-subtitle" style="font-size: 11px; color: #9ca3af; margin: 4px 0 0 0; font-weight: normal; text-transform: none;">Last 5 sessions vs 30-day average</p>
          </div>

          <% if @skill_snapshot.present? %>
            <div class="skill-grid">
              <div class="skill-item">
                <div class="skill-name">
                  Clarity
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Clarity measures articulation, pace consistency, and pause quality
                    </span>
                  </span>
                </div>
                <div class="skill-score"><%= @skill_snapshot[:clarity][:score] %></div>
                <div class="skill-delta <%= @skill_snapshot[:clarity][:delta] >= 0 ? 'positive' : 'negative' %>">
                  <%= @skill_snapshot[:clarity][:delta] >= 0 ? '▲' : '▼' %>
                  <%= @skill_snapshot[:clarity][:delta].abs %>
                </div>
              </div>

              <div class="skill-item">
                <div class="skill-name">
                  Filler %
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Percentage of words that are fillers (um, uh, like). Lower is better.
                    </span>
                  </span>
                </div>
                <div class="skill-score"><%= @skill_snapshot[:filler_rate][:score] %>%</div>
                <div class="skill-delta <%= @skill_snapshot[:filler_rate][:delta] <= 0 ? 'positive' : 'negative' %>">
                  <%= @skill_snapshot[:filler_rate][:delta] <= 0 ? '▼' : '▲' %>
                  <%= @skill_snapshot[:filler_rate][:delta].abs %>%
                </div>
              </div>

              <div class="skill-item">
                <div class="skill-name">
                  Pace
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Your speaking rate in words per minute. Ideal range: 140-170 WPM
                    </span>
                  </span>
                </div>
                <div class="skill-score"><%= @skill_snapshot[:pace][:score] %></div>
                <div class="skill-delta <%= @skill_snapshot[:pace][:delta] >= 0 ? 'positive' : 'negative' %>">
                  <%= @skill_snapshot[:pace][:delta] >= 0 ? '▲' : '▼' %>
                  <%= @skill_snapshot[:pace][:delta].abs %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Right Column -->
      <div class="progress-right-column">
        <!-- Progress Toward Goals -->
        <div class="progress-charts-card" data-controller="progress-dashboard">
          <div class="card-header">
            <h3>PROGRESS TOWARD GOALS</h3>
          </div>

          <div class="time-range-filters">
            <button class="time-range-btn <%= @time_range == '7' ? 'active' : '' %>"
                    data-range="7"
                    data-action="click->progress-dashboard#changeTimeRange">
              Last 7 Sessions
            </button>
            <button class="time-range-btn <%= @time_range == '30' ? 'active' : '' %>"
                    data-range="30"
                    data-action="click->progress-dashboard#changeTimeRange">
              Last 30 Sessions
            </button>
            <button class="time-range-btn <%= @time_range == 'lifetime' ? 'active' : '' %>"
                    data-range="lifetime"
                    data-action="click->progress-dashboard#changeTimeRange">
              Lifetime
            </button>
          </div>

          <% if @chart_data.present? && @chart_data[:labels].any? %>
            <!-- Filler % Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Filler %
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Percentage of words that are fillers (um, uh, like)
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:filler_data].last %>%
                  <%= @chart_data[:filler_data][-2] && @chart_data[:filler_data].last < @chart_data[:filler_data][-2] ? '↗' : '' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="fillerChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:filler_data].to_json %>"
                      data-goal="2.0"></canvas>
              <div class="chart-footer">
                <span>Goal ≤ 2.0%</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <!-- Pace (WPM) Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Pace (WPM)
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Words per minute - optimal range is 140-170 WPM
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:pace_data].last %>
                  <%= @chart_data[:pace_data][-2] && @chart_data[:pace_data].last > @chart_data[:pace_data][-2] ? '↗' : '' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="paceChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:pace_data].to_json %>"
                      data-goal="150"></canvas>
              <div class="chart-footer">
                <span>Goal 140–170 WPM</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <!-- Clarity Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Clarity
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Overall speech clarity score based on articulation and fluency
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:clarity_data].last %>
                  <%= @chart_data[:clarity_data][-2] && @chart_data[:clarity_data].last > @chart_data[:clarity_data][-2] ? '↗' : '✓' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="clarityChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:clarity_data].to_json %>"
                      data-goal="90"></canvas>
              <div class="chart-footer">
                <span>Goal ≥ 90</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <!-- Pace Consistency Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Pace Consistency
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Measures how steady your speaking pace is throughout the session
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:pace_consistency_data].last %>%
                  <%= @chart_data[:pace_consistency_data][-2] && @chart_data[:pace_consistency_data].last > @chart_data[:pace_consistency_data][-2] ? '↗' : '✓' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="paceConsistencyChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:pace_consistency_data].to_json %>"
                      data-goal="80"></canvas>
              <div class="chart-footer">
                <span>Goal ≥ 80%</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <!-- Fluency Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Fluency
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Smoothness of delivery without interruptions or hesitations
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:fluency_data].last %>%
                  <%= @chart_data[:fluency_data][-2] && @chart_data[:fluency_data].last > @chart_data[:fluency_data][-2] ? '↗' : '✓' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="fluencyChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:fluency_data].to_json %>"
                      data-goal="85"></canvas>
              <div class="chart-footer">
                <span>Goal ≥ 85%</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <!-- Engagement Chart -->
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">
                  Engagement
                  <span class="info-btn" data-controller="tooltip" data-action="mouseenter->tooltip#show mouseleave->tooltip#hide">
                    <%= icon_svg(:info, css_class: 'icon-inline') %>
                    <span data-tooltip-target="content" class="tooltip-content hidden">
                      Energy level and vocal variety in your speech
                    </span>
                  </span>
                </span>
                <span class="chart-current-value">
                  <%= @chart_data[:engagement_data].last %>%
                  <%= @chart_data[:engagement_data][-2] && @chart_data[:engagement_data].last > @chart_data[:engagement_data][-2] ? '↗' : '✓' %>
                </span>
              </div>
              <canvas data-progress-dashboard-target="engagementChart"
                      data-labels="<%= @chart_data[:labels].to_json %>"
                      data-values="<%= @chart_data[:engagement_data].to_json %>"
                      data-goal="75"></canvas>
              <div class="chart-footer">
                <span>Goal ≥ 75%</span>
                <span>
                  <% case @time_range
                     when '7' %>
                    Last 7 sessions
                  <% when '30' %>
                    Last 30 sessions
                  <% when 'lifetime' %>
                    All <%= @chart_data[:session_count] %> sessions
                  <% end %>
                </span>
              </div>
            </div>

            <div class="chart-note">
              Each dot is a session. The dashed line shows your target.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="no-sessions-message">
      <h3><%= icon_svg(:mic, css_class: 'icon-inline') %> No Sessions Yet</h3>
      <p>Complete a few practice sessions to see your progress dashboard!</p>
      <%= link_to "Start Practicing", practice_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>
