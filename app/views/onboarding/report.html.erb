<% content_for :title, "Your Results - AI Talk Coach" %>

<div class="onboarding-container">
  <div class="onboarding-content">
    <!-- Quit Button - Top Right -->
    <%= link_to logout_path, class: 'quit-btn-top-right', data: { turbo: false, turbo_confirm: "Are you sure you want to quit? You'll need to start over." } do %>
      <span class="quit-icon">×</span>
    <% end %>

    <!-- Back Button - Top Left -->
    <%= render 'onboarding/back_button', back_path: onboarding_test_path %>

    <% if @trial_session && !@trial_session.completed? %>
      <!-- Processing State - Show loading -->
      <div class="processing-container" id="processingContainer">
        <div class="processing-content">
          <div class="processing-spinner"></div>
          <h1 class="processing-title">Analyzing Your Speech...</h1>
          <p class="processing-subtitle">This usually takes 10-20 seconds</p>
        </div>
      </div>

      <script>
        (function() {
          const trialSessionToken = '<%= @trial_session.token %>';
          let pollCount = 0;
          const maxPolls = 60; // 2 minutes max

          function pollStatus() {
            if (pollCount >= maxPolls) {
              console.error('Polling timeout - max attempts reached');
              return;
            }

            pollCount++;

            fetch(`/api/trial_sessions/${trialSessionToken}/status`, {
              headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.completed) {
                // Reload page to show results
                window.location.reload();
              } else {
                // Continue polling
                setTimeout(pollStatus, 2000);
              }
            })
            .catch(error => {
              console.error('Polling error:', error);
              setTimeout(pollStatus, 2000);
            });
          }

          // Start polling after 1 second
          setTimeout(pollStatus, 1000);
        })();
      </script>
    <% else %>
      <!-- Report Section - Show results when completed -->
      <div class="report-section">
      <% if @trial_session&.title&.include?("Mock Data") %>
        <!-- Mock Data Notice -->
        <div class="mock-data-notice">
          <div class="notice-icon">ℹ️</div>
          <div class="notice-content">
            <strong>Sample Preview</strong> — This is mock data to show you what your reports will look like. Record a real session to see your actual results!
          </div>
        </div>
      <% end %>

      <h1 class="report-title">Here's What We Found</h1>
      <p class="report-subtitle">Your speaking snapshot in 30 seconds</p>

      <!-- Metrics Cards - 3 Column -->
      <div class="metrics-grid">
        <!-- Clarity Score -->
        <% if @trial_session&.clarity_score.present? %>
          <div class="metric-card">
            <div class="metric-icon-container clarity-icon">
              <%= image_tag 'icons/clarity.png', alt: 'Clarity', class: 'metric-icon-img' %>
            </div>
            <div class="metric-value"><%= @trial_session.clarity_score.round %>%</div>
            <div class="metric-label">Clarity Score</div>
            <div class="metric-description">
              <% clarity = @trial_session.clarity_score %>
              <% if clarity > 85 %>
                Very clear
              <% elsif clarity > 70 %>
                Generally clear
              <% else %>
                Needs improvement
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Filler Rate -->
        <% if @trial_session&.filler_rate.present? %>
          <div class="metric-card">
            <div class="metric-icon-container filler-icon">
              <%= image_tag 'icons/filler-words.png', alt: 'Filler Words', class: 'metric-icon-img' %>
            </div>
            <div class="metric-value"><%= @trial_session.filler_rate.round(1) %>%</div>
            <div class="metric-label">Filler Words</div>
            <div class="metric-description">
              <% if @trial_session.filler_rate < 3 %>
                <span style="color: #10b981;">Great! Under 3%</span>
              <% else %>
                Target: &lt;3%
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Pace (WPM) -->
        <% if @trial_session&.wpm.present? %>
          <div class="metric-card">
            <div class="metric-icon-container pace-icon">
              <%= image_tag 'icons/speaking-pace.png', alt: 'Speaking Pace', class: 'metric-icon-img' %>
            </div>
            <div class="metric-value"><%= @trial_session.wpm.to_i %> <span class="unit">wpm</span></div>
            <div class="metric-label">Speaking Pace</div>
            <div class="metric-description">
              <% wpm = @trial_session.wpm.to_i %>
              <% if wpm >= 130 && wpm <= 150 %>
                <span style="color: #10b981;">Optimal</span>
              <% elsif wpm >= 110 && wpm < 130 %>
                <span style="color: #3b82f6;">Slightly slow</span>
              <% elsif wpm > 150 && wpm <= 170 %>
                <span style="color: #3b82f6;">Slightly fast</span>
              <% elsif wpm < 110 %>
                Too slow
              <% else %>
                Too fast
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- AI Recommendation -->
      <% if @trial_session.present? %>
        <div class="recommendation-section">
          <div class="recommendation-header-row">
            <div class="recommendation-label">Coach Recommendation:</div>
            <%
              # Determine top priority based on metrics
              filler_rate = @trial_session.filler_rate || 0
              wpm = @trial_session.wpm || 0
              clarity = @trial_session.clarity_score || 0

              if filler_rate > 5
                recommendation_title = "Reduce Filler Words"
                recommendation_text = "Try pausing for 0.5-1 seconds when you don't know what to say next. Silence is better than 'um' or 'uh'. This will make you sound more confident and help listeners focus on your message instead of distracting filler words."
              elsif wpm < 110
                recommendation_title = "Speed Up Your Pace"
                recommendation_text = "Aim for 130-150 words per minute for optimal delivery. Practice reading aloud daily and gradually increase your speed while maintaining clarity. A natural pace keeps your audience engaged."
              elsif wpm > 170
                recommendation_title = "Slow Down Your Pace"
                recommendation_text = "Aim for 130-150 words per minute so listeners can follow along better. Take deliberate pauses between sentences and key points. Speaking too fast can overwhelm your audience and reduce comprehension."
              elsif clarity < 75
                recommendation_title = "Improve Clarity"
                recommendation_text = "Focus on articulating each word clearly and reducing filler words. Practice recording yourself and listening back for unclear moments. Clear speech builds credibility and ensures your message lands effectively."
              else
                recommendation_title = "Keep Practicing Daily"
                recommendation_text = "You're doing well! Continue practicing daily to maintain and improve your speaking skills. Consistency is key—even 1-2 minutes daily makes a significant difference in building lasting confidence."
              end
            %>
            <div class="recommendation-title"><%= recommendation_title %></div>
          </div>
          <div class="recommendation-card">
            <p class="recommendation-text"><%= recommendation_text %></p>
          </div>
        </div>
      <% end %>

      <!-- Transcript Preview -->
      <% if @trial_session&.transcript.present? %>
        <div class="transcript-preview">
          <div class="transcript-header">What You Said</div>
          <div class="transcript-text">
            <%= simple_format(@trial_session.transcript) %>
          </div>
        </div>
      <% end %>

      <!-- What You'll Unlock Section -->
      <div class="unlock-section">
        <h2 class="unlock-title">What You'll Unlock</h2>

        <div class="unlock-grid">
          <div class="unlock-item">
            <div class="unlock-icon-container">
              <%= image_tag 'icons/ai-coach.png', alt: 'AI Coach', class: 'unlock-icon-img' %>
            </div>
            <div class="unlock-text">
              <div class="unlock-feature">AI Coach Recommendations</div>
            </div>
          </div>

          <div class="unlock-item">
            <div class="unlock-icon-container">
              <%= image_tag 'icons/advanced-metrics.png', alt: 'Advanced Metrics', class: 'unlock-icon-img' %>
            </div>
            <div class="unlock-text">
              <div class="unlock-feature">Advanced Metrics</div>
              <div class="unlock-description">(pitch, energy, pauses)</div>
            </div>
          </div>

          <div class="unlock-item">
            <div class="unlock-icon-container">
              <%= image_tag 'icons/custom-plan.png', alt: 'Custom Plan', class: 'unlock-icon-img' %>
            </div>
            <div class="unlock-text">
              <div class="unlock-feature">Custom Improvement Plan</div>
            </div>
          </div>

          <div class="unlock-item">
            <div class="unlock-icon-container">
              <%= image_tag 'icons/progress-tracking.png', alt: 'Progress Tracking', class: 'unlock-icon-img' %>
            </div>
            <div class="unlock-text">
              <div class="unlock-feature">Progress Tracking</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Continue Button -->
    <div class="floating-button-container">
      <%= link_to onboarding_cinematic_path, class: 'primary-btn btn-large' do %>
        Continue
        <span aria-hidden="true">→</span>
      <% end %>

      <!-- Progress Dots -->
      <div class="progress-dots">
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
      </div>
    </div>
    <% end %>
  </div>
</div>

<style>
  /* Processing Container */
  .processing-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .processing-content {
    text-align: center;
    max-width: 400px;
  }

  .processing-spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 2rem;
    border: 4px solid #e5e7eb;
    border-top-color: #FF8C42;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .processing-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .processing-subtitle {
    font-size: 1rem;
    color: #64748b;
  }

  /* Container */
  .onboarding-container {
    min-height: 100vh;
    position: relative;
    background-color: #F8FAFC;
  }

  .onboarding-content {
    min-height: 100vh;
    padding: 0;
  }

  /* Quit Button */
  .quit-btn-top-right {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f1f5f9;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    z-index: 100;
  }

  .quit-btn-top-right:hover {
    background-color: #e2e8f0;
  }

  .quit-btn-top-right .quit-icon {
    font-size: 20px;
    color: #64748b;
    line-height: 1;
  }

  /* Report Section */
  .report-section {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1.5rem 6rem 1.5rem;
  }

  .report-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    text-align: center;
    margin-bottom: 0.35rem;
  }

  .report-subtitle {
    font-size: 0.875rem;
    color: #64748b;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  /* Mock Data Notice */
  .mock-data-notice {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background: linear-gradient(135deg, #FFF9F5 0%, #FFF4ED 100%);
    border: 2px solid #FFE8D9;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(255, 140, 66, 0.08);
  }

  .notice-icon {
    font-size: 1.25rem;
    line-height: 1;
    flex-shrink: 0;
  }

  .notice-content {
    font-size: 0.9375rem;
    color: #1e293b;
    line-height: 1.5;
  }

  .notice-content strong {
    color: #FF8C42;
    font-weight: 600;
  }

  /* Metrics Grid - 3 Columns */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .metric-card {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    transition: all 0.2s ease;
  }

  .metric-card:hover {
    border-color: #FF8C42;
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.15);
    transform: translateY(-2px);
  }

  .metric-icon-container {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
  }

  .metric-icon-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.375rem;
    line-height: 1;
  }

  .metric-value .unit {
    font-size: 1rem;
    font-weight: 600;
    color: #64748b;
  }

  .metric-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .metric-description {
    font-size: 0.8125rem;
    color: #64748b;
  }

  /* AI Recommendation */
  .recommendation-section {
    margin-bottom: 1.5rem;
  }

  .recommendation-header-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .recommendation-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #64748b;
  }

  .recommendation-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #FF8C42;
  }

  .recommendation-card {
    background: linear-gradient(135deg, #FFF9F5 0%, #FFF4ED 100%);
    border: 2px solid #FFE8D9;
    border-radius: 12px;
    padding: 1.25rem;
  }

  .recommendation-text {
    font-size: 0.9375rem;
    color: #1e293b;
    line-height: 1.6;
    margin: 0;
  }

  /* Transcript Preview */
  .transcript-preview {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .transcript-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .transcript-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: #1e293b;
    max-height: 150px;
    overflow-y: auto;
  }

  /* What You'll Unlock Section */
  .unlock-section {
    margin-top: 1.75rem;
    margin-bottom: 1.25rem;
  }

  .unlock-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    text-align: center;
    margin-bottom: 1rem;
  }

  .unlock-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .unlock-item {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    transition: all 0.2s ease;
  }

  .unlock-item:hover {
    border-color: #FF8C42;
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.15);
    transform: translateY(-2px);
  }

  .unlock-icon-container {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .unlock-icon-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .unlock-text {
    flex: 1;
  }

  .unlock-feature {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
  }

  .unlock-description {
    font-size: 0.8125rem;
    color: #64748b;
    line-height: 1.4;
  }

  /* Floating Button Container */
  .floating-button-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.25rem 1.5rem;
    background: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    z-index: 50;
    pointer-events: none;
  }

  .primary-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #FF8C42 0%, #FF7028 100%);
    color: white;
    padding: 0.875rem 2rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
    pointer-events: auto;
  }

  .primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 140, 66, 0.4);
  }

  /* Progress Dots */
  .progress-dots {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .progress-dot {
    width: 8px;
    height: 8px;
    border-radius: 4px;
    background-color: #cbd5e1;
    transition: all 0.3s ease;
  }

  .progress-dot.active {
    width: 24px;
    background-color: #FF8C42;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .metrics-grid {
      grid-template-columns: 1fr;
    }

    .unlock-grid {
      grid-template-columns: 1fr;
    }

    .report-title {
      font-size: 1.5rem;
    }

    .metric-value {
      font-size: 2rem;
    }

    .unlock-title {
      font-size: 1.125rem;
    }

    .floating-button-container {
      padding: 1rem;
    }
  }
</style>
