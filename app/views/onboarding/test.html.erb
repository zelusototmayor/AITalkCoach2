<% content_for :title, "Try a Quick Test - AI Talk Coach" %>

<div class="onboarding-container">
  <div class="onboarding-content">
    <!-- Quit Button - Top Right -->
    <%= link_to logout_path, class: 'quit-btn-top-right', data: { turbo: false, turbo_confirm: "Are you sure you want to quit? You'll need to start over." } do %>
      <span class="quit-icon">×</span>
    <% end %>

    <!-- Back Button - Top Left -->
    <%= render 'onboarding/back_button', back_path: onboarding_demographics_path %>

    <!-- Fresh Test Interface -->
    <div class="test-section"
         data-controller="recorder"
         data-recorder-audio-only-value="true"
         data-recorder-max-duration-sec-value="30">

      <h1 class="test-title">Let's see where you're at</h1>
      <p class="test-subtitle">Try a 30-second practice session</p>

      <!-- Prompt Card (Web App Style) -->
      <div class="prompt-card-webapp">
        <div class="prompt-header-row">
          <div class="prompt-header">Your Prompt</div>
          <div class="prompt-duration">30 seconds</div>
        </div>
        <div class="prompt-question">What was something you enjoyed about last week and why?</div>
      </div>

      <!-- Recording Form -->
      <%= form_with url: onboarding_test_path, method: :post, data: { recorder_target: "form", turbo: false }, id: "recording-form" do |f| %>
        <%= hidden_field_tag 'trial_recording', 'true' %>
        <%= file_field_tag 'audio_file',
                           accept: 'audio/*,video/*',
                           style: 'display: none;',
                           data: { recorder_target: 'fileInput' } %>

        <!-- Recording Interface (Web App Style) -->
        <div class="recording-interface">
          <!-- Ready State -->
          <div data-recorder-target="readyState" style="display: block;">
            <div class="webapp-recording-ui">
              <button type="button"
                      class="webapp-start-btn"
                      data-action="click->recorder#startRecording"
                      data-recorder-target="recordBtn">
                <span class="play-icon">▶</span> Start 30 seconds
              </button>

              <div class="webapp-progress-circle">
                <svg viewBox="0 0 120 120" class="progress-svg">
                  <circle cx="60" cy="60" r="54" class="progress-bg"></circle>
                  <circle cx="60" cy="60" r="54" class="progress-ring"></circle>
                </svg>
                <div class="progress-content">
                  <div class="progress-percent">0%</div>
                  <div class="progress-status">READY</div>
                </div>
              </div>

              <div class="webapp-timer">0s / 30s</div>
            </div>
            <p class="recording-tip">Speak naturally. Don't worry about perfection!</p>
            <div data-recorder-target="statusText" class="recording-status-text"></div>
          </div>

          <!-- Recording State -->
          <div data-recorder-target="recordingState" style="display: none;">
            <div class="webapp-recording-ui">
              <button type="button"
                      class="webapp-start-btn recording"
                      data-action="click->recorder#stopRecording">
                <span class="stop-icon">■</span> Stop
              </button>

              <div class="webapp-progress-circle recording">
                <svg viewBox="0 0 120 120" class="progress-svg">
                  <circle cx="60" cy="60" r="54" class="progress-bg"></circle>
                  <circle cx="60" cy="60" r="54" class="progress-ring" data-recorder-target="progressCircle"></circle>
                </svg>
                <div class="progress-content">
                  <div class="progress-percent" data-recorder-target="percentage">0%</div>
                  <div class="progress-status">REC</div>
                </div>
              </div>

              <div class="webapp-timer" data-recorder-target="recordingTimer">0s / 30s</div>
            </div>

            <div class="recording-actions">
              <button type="button"
                      class="action-btn cancel"
                      data-action="click->recorder#cancelRecording">
                Cancel & Start Over
              </button>
            </div>
          </div>

          <!-- Processing State -->
          <div data-recorder-target="processingState" style="display: none;">
            <div class="processing-state">
              <div class="spinner"></div>
              <p class="processing-message">Processing your recording...</p>
            </div>
          </div>

          <!-- Completed State -->
          <div data-recorder-target="completedState" style="display: none;">
            <div class="completed-state">
              <div class="completed-icon">✓</div>
              <p class="completed-message">Recording complete! Uploading for analysis...</p>
            </div>
            <audio controls data-recorder-target="audioPreview" style="display: none; width: 100%; margin: 20px 0;"></audio>
            <button type="submit"
                    class="primary-btn btn-large"
                    data-recorder-target="submitBtn"
                    style="display: none;">
              Analyze Recording
            </button>
          </div>
        </div>
      <% end %>

      <!-- Skip Option -->
      <div class="skip-section">
        <%= form_with url: onboarding_test_path, method: :post, data: { turbo: false } do |f| %>
          <%= hidden_field_tag 'skipped', 'true' %>
          <%= button_tag type: 'submit', class: 'skip-btn' do %>
            Skip for now →
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Progress Dots (Fixed at bottom) -->
    <div class="progress-dots-container">
      <div class="progress-dots">
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Container */
  .onboarding-container {
    min-height: 100vh;
    position: relative;
    background-color: #F8FAFC;
  }

  .onboarding-content {
    min-height: 100vh;
    padding: 0;
  }

  /* Quit Button */
  .quit-btn-top-right {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f1f5f9;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    z-index: 100;
  }

  .quit-btn-top-right:hover {
    background-color: #e2e8f0;
  }

  .quit-btn-top-right .quit-icon {
    font-size: 20px;
    color: #64748b;
    line-height: 1;
  }

  /* Test Section */
  .test-section {
    max-width: 600px;
    margin: 0 auto;
    padding: 3rem 1.5rem 6rem 1.5rem;
  }

  .test-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    text-align: center;
    margin-bottom: 0.35rem;
  }

  .test-subtitle {
    font-size: 0.875rem;
    color: #64748b;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  /* Prompt Card (Web App Style) */
  .prompt-card-webapp {
    background: linear-gradient(135deg, #FFF9F5 0%, #FFF4ED 100%);
    border: 2px solid #FFE8D9;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(255, 140, 66, 0.08);
  }

  .prompt-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .prompt-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: #FF8C42;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .prompt-duration {
    font-size: 0.8rem;
    font-weight: 600;
    color: #94a3b8;
  }

  .prompt-question {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
    line-height: 1.5;
  }

  /* Web App Style Recording UI */
  .webapp-recording-ui {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 500px;
    margin: 0 auto 1.5rem auto;
  }

  /* Start Button (Web App Style) */
  .webapp-start-btn {
    background: linear-gradient(135deg, #FF8C42 0%, #FF7028 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 0.85rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 8px rgba(255, 140, 66, 0.3);
    min-width: 120px;
    justify-content: center;
    flex-shrink: 0;
  }

  .webapp-start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.4);
  }

  .webapp-start-btn.recording {
    background: #dc2626;
  }

  .webapp-start-btn.recording:hover {
    background: #b91c1c;
  }

  .play-icon {
    font-size: 1.1rem;
  }

  .stop-icon {
    font-size: 1rem;
  }

  /* Progress Circle (Web App Style) */
  .webapp-progress-circle {
    position: relative;
    width: 120px;
    height: 120px;
  }

  .progress-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .progress-bg {
    fill: none;
    stroke: #e5e7eb;
    stroke-width: 8;
  }

  .progress-ring {
    fill: none;
    stroke: #cbd5e1;
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 339.292;
    stroke-dashoffset: 339.292;
    transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;
  }

  .webapp-progress-circle.recording .progress-ring {
    stroke: #FF8C42;
  }

  .progress-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .progress-percent {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
    margin: 0;
  }

  .progress-status {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    letter-spacing: 0.05em;
    margin: 0.25rem 0 0 0;
  }

  /* Timer Display (Web App Style) */
  .webapp-timer {
    font-size: 1.1rem;
    font-weight: 600;
    color: #64748b;
    min-width: 80px;
    text-align: center;
    flex-shrink: 0;
  }

  .recording-tip {
    text-align: center;
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  /* Recording Actions */
  .recording-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 1rem;
  }

  .action-btn {
    padding: 0.6rem 1.25rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .action-btn.secondary {
    background: #f1f5f9;
    color: #1e293b;
  }

  .action-btn.secondary:hover {
    background: #e2e8f0;
  }

  .action-btn.cancel {
    background: transparent;
    color: #64748b;
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
  }

  .action-btn.cancel:hover {
    background: #f1f5f9;
    color: #1e293b;
  }

  /* Processing State */
  .processing-state {
    text-align: center;
    padding: 2rem;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top-color: #FF8C42;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .processing-message {
    font-size: 0.95rem;
    color: #64748b;
    font-weight: 500;
  }

  /* Completed State */
  .completed-state {
    text-align: center;
    padding: 2rem;
  }

  .completed-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    margin: 0 auto 1rem;
  }

  .completed-message {
    font-size: 0.95rem;
    color: #10b981;
    font-weight: 600;
  }

  /* Skip Section */
  .skip-section {
    text-align: center;
    margin-top: 1.5rem;
  }

  .skip-btn {
    background: transparent;
    border: none;
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
  }

  .skip-btn:hover {
    color: #1e293b;
  }

  /* Progress Dots Container */
  .progress-dots-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.25rem;
    display: flex;
    justify-content: center;
    z-index: 50;
    pointer-events: none;
  }

  .progress-dots {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .progress-dot {
    width: 8px;
    height: 8px;
    border-radius: 4px;
    background-color: #cbd5e1;
    transition: all 0.3s ease;
  }

  .progress-dot.active {
    width: 24px;
    background-color: #FF8C42;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .test-title {
      font-size: 1.5rem;
    }

    .webapp-recording-ui {
      flex-direction: column;
      gap: 1.5rem;
      max-width: 100%;
    }

    .webapp-start-btn {
      width: 100%;
      max-width: 200px;
    }

    .webapp-timer {
      min-width: 60px;
    }
  }
</style>

<script>
  // Update timer and progress circle during recording
  document.addEventListener('turbo:load', function() {
    const recorder = document.querySelector('[data-controller="recorder"]');
    if (!recorder) return;

    // Timer element
    const timerElement = recorder.querySelector('[data-recorder-target="recordingTimer"]');
    const percentElement = recorder.querySelector('[data-recorder-target="percentage"]');
    const progressCircle = recorder.querySelector('[data-recorder-target="progressCircle"]');

    if (timerElement) {
      // Format as "Xs / 60s" and update progress
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            const text = timerElement.textContent;

            // If it's in format "0:30", convert to "Xs / 60s"
            if (text.includes(':')) {
              const parts = text.split(':');
              const minutes = parseInt(parts[0]);
              const seconds = parseInt(parts[1]);
              const totalSeconds = minutes * 60 + seconds;
              const remaining = 30 - totalSeconds;
              const elapsed = 30 - remaining;

              timerElement.textContent = `${elapsed}s / 30s`;

              // Update percentage
              const percent = Math.round((elapsed / 30) * 100);
              if (percentElement) {
                percentElement.textContent = `${percent}%`;
              }

              // Update progress circle
              if (progressCircle) {
                const circumference = 2 * Math.PI * 54; // r=54
                const offset = circumference - (elapsed / 30) * circumference;
                progressCircle.style.strokeDashoffset = offset;
              }
            }
          }
        });
      });

      observer.observe(timerElement, {
        childList: true,
        characterData: true,
        subtree: true
      });
    }
  });
</script>
