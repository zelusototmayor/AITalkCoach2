<% content_for :title, @trial_session.title %>

<div class="session-show-clean trial-session"
     data-controller="progress"
     data-action="analytics#handleTrialAnalysisView"
     data-progress-session-token-value="<%= @trial_session.token %>"
     data-progress-api-endpoint-value="/api/trial_sessions/<%= @trial_session.token %>/status"
     <% if @trial_session.processing? %>
     data-refresh-url="<%= trial_session_path(@trial_session.token) %>"
     data-auto-refresh="true"
     data-refresh-interval="5000"
     <% end %>>

  <!-- Trial Header with Upgrade CTA -->
  <div class="session-header trial-header">
    <div class="session-title-section">
      <h1><%= @trial_session.title %> <span class="trial-badge">TRIAL</span></h1>
      <div class="session-meta">
        <span class="language-badge"><%= @trial_session.language.upcase %></span>
        <span class="media-type"><%= @trial_session.media_kind.capitalize %></span>
        <span class="session-date">
          <%= @trial_session.created_at.strftime("%B %d, %Y at %l:%M %p") %>
        </span>
      </div>
    </div>

    <div class="session-actions">
      <%= link_to "← Try Another Recording", practice_path(trial: true), class: "btn btn-secondary" %>
      <%= link_to "🚀 Unlock Full Features", signup_path(trial_token: @trial_session.token),
            class: "btn btn-primary cta-button",
            data: {
              action: "click->analytics#handleSignupClick",
              source: "trial_session_header"
            } %>
    </div>
  </div>

  <!-- Processing Status -->
  <% if @trial_session.processing_state != 'completed' %>
    <div class="processing-status status-<%= @trial_session.processing_state %>"
         data-progress-target="status">
      <% case @trial_session.processing_state %>
      <% when 'pending' %>
        <div class="status-card">
          <span class="status-icon">⏳</span>
          <div class="status-content">
            <h3 data-progress-target="step">Trial Analysis Pending</h3>
            <p data-progress-target="statusText">Your trial recording is queued for analysis. <strong><%= @trial_session.estimated_completion_time %></strong></p>
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar"
                     style="width: 5%" role="progressbar"
                     aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Starting soon...</span>
              </small>
            </div>
            <div class="trial-note">
              💡 <strong>Trial mode:</strong> Basic analysis only. <a href="<%= signup_path(trial_token: @trial_session.token) %>">Sign up</a> for detailed feedback, progress tracking, and unlimited sessions.
            </div>
          </div>
        </div>
      <% when 'processing' %>
        <div class="status-card">
          <span class="status-icon">⚡</span>
          <div class="status-content">
            <h3 data-progress-target="step">Analyzing Your Recording</h3>
            <p data-progress-target="statusText">Processing your speech for basic insights... <strong><%= @trial_session.estimated_completion_time %></strong></p>
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar" data-progress-target="progressBar"
                     style="width: 30%" role="progressbar"
                     aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="progress-text">
                <span data-progress-target="estimatedTime">Analyzing...</span>
              </small>
            </div>
            <div class="trial-note">
              💡 <strong>Trial mode:</strong> Basic analysis only. <a href="<%= signup_path(trial_token: @trial_session.token) %>">Sign up</a> for AI-powered insights and detailed coaching.
            </div>
          </div>
        </div>
      <% when 'failed' %>
        <div class="status-card error">
          <span class="status-icon">❌</span>
          <div class="status-content">
            <h3 data-progress-target="step">Trial Analysis Failed</h3>
            <p data-progress-target="statusText"><%= @trial_session.analysis_data&.dig('error') || "Demo analysis failed. This is expected in trial mode." %></p>
            <div class="error-actions">
              <%= link_to "🎙️ Try Again", practice_path(trial: true), class: "btn btn-primary" %>
              <%= link_to "🚀 Get Reliable Processing", signup_path(trial_token: @trial_session.token), class: "btn btn-secondary" %>
            </div>
            <div class="trial-note">
              💡 <strong>Trial limitations:</strong> Unreliable processing is normal. <a href="<%= signup_path(trial_token: @trial_session.token) %>">Sign up</a> for professional-grade analysis.
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Trial Results (Basic/Limited) -->
  <% if @trial_session.processing_state == 'completed' || (@trial_session.processing_state == 'failed' && @trial_session.analysis_data&.dig('demo_mode')) %>

    <!-- Upgrade Banner -->
    <div class="upgrade-banner">
      <div class="upgrade-content">
        <div class="upgrade-text">
          <h3>🎉 Trial Complete!</h3>
          <p>You got a taste of AI Talk Coach. Sign up for unlimited sessions, detailed analysis, and progress tracking.</p>
        </div>
        <%= link_to "Get Full Access", signup_path(trial_token: @trial_session.token),
              class: "btn btn-primary btn-large",
              data: {
                action: "click->analytics#handleSignupClick",
                source: "trial_complete_banner"
              } %>
      </div>
    </div>

    <!-- Basic Metrics (Limited for Trial) -->
    <div class="trial-metrics-overview">
      <h2>Your Basic Results</h2>
      <div class="trial-metrics-grid">

        <div class="trial-metric-card">
          <div class="metric-header">
            <span class="metric-icon">💬</span>
            <span class="metric-label">Speaking Pace</span>
          </div>
          <div class="metric-value-large"><%= @trial_session.wpm || 0 %> WPM</div>
          <div class="metric-feedback">
            <% wpm = @trial_session.wpm || 0 %>
            <% if wpm >= 140 && wpm <= 180 %>
              Great natural pace!
            <% elsif wpm < 140 %>
              Try speaking a bit faster
            <% else %>
              Try slowing down slightly
            <% end %>
          </div>
          <div class="upgrade-hint">🔒 Get detailed pace analysis with full version</div>
        </div>

        <div class="trial-metric-card">
          <div class="metric-header">
            <span class="metric-icon">🎯</span>
            <span class="metric-label">Filler Words</span>
          </div>
          <div class="metric-value-large"><%= @trial_session.filler_count || 0 %></div>
          <div class="metric-feedback">
            <% filler_rate = @trial_session.filler_rate %>
            <% if filler_rate < 3 %>
              Excellent control!
            <% elsif filler_rate < 7 %>
              Good, room for improvement
            <% else %>
              Focus on reducing fillers
            <% end %>
          </div>
          <div class="upgrade-hint">🔒 Get filler word timeline with full version</div>
        </div>

        <div class="trial-metric-card">
          <div class="metric-header">
            <span class="metric-icon">⭐</span>
            <span class="metric-label">Overall Score</span>
          </div>
          <div class="metric-value-large"><%= @trial_session.clarity_score.round %>%</div>
          <div class="metric-feedback">
            <% score = @trial_session.clarity_score %>
            <% if score > 85 %>
              Excellent clarity!
            <% elsif score > 70 %>
              Good, keep practicing
            <% else %>
              Room for improvement
            <% end %>
          </div>
          <div class="upgrade-hint">🔒 Get AI-powered coaching with full version</div>
        </div>

      </div>
    </div>

    <!-- Transcript Section (Basic) -->
    <% if @trial_session.transcript&.present? %>
      <div class="trial-transcript-section">
        <div class="section-header">
          <h3>Basic Transcript</h3>
          <div class="trial-limitation">
            🔒 <strong>Trial Limitation:</strong> No interactive features, issue highlighting, or search.
            <a href="<%= signup_path(trial_token: @trial_session.token) %>">Upgrade</a> for full transcript experience.
          </div>
        </div>

        <div class="trial-transcript-content">
          <%= simple_format(@trial_session.transcript) %>
        </div>
      </div>
    <% end %>

    <!-- What You're Missing (Upgrade Incentive) -->
    <div class="missing-features">
      <h3>🚀 What You're Missing</h3>
      <div class="missing-features-grid">

        <div class="missing-feature">
          <div class="feature-icon">🎯</div>
          <div class="feature-info">
            <h4>Detailed Issue Analysis</h4>
            <p>See exactly where you used filler words, paused too long, or spoke unclearly - with timestamps to jump to each moment.</p>
          </div>
        </div>

        <div class="missing-feature">
          <div class="feature-icon">🤖</div>
          <div class="feature-info">
            <h4>AI-Powered Coaching</h4>
            <p>Get personalized improvement suggestions, rewrite suggestions, and coaching tips based on your speaking patterns.</p>
          </div>
        </div>

        <div class="missing-feature">
          <div class="feature-icon">📈</div>
          <div class="feature-info">
            <h4>Progress Tracking</h4>
            <p>Track your improvement over time with detailed analytics, trends, and achievement milestones.</p>
          </div>
        </div>

        <div class="missing-feature">
          <div class="feature-icon">🎥</div>
          <div class="feature-info">
            <h4>Audio/Video Playback</h4>
            <p>Listen back to your recording with synchronized transcript highlighting and issue markers.</p>
          </div>
        </div>

        <div class="missing-feature">
          <div class="feature-icon">♾️</div>
          <div class="feature-info">
            <h4>Unlimited Sessions</h4>
            <p>Practice as much as you want with no limits on session length or frequency.</p>
          </div>
        </div>

        <div class="missing-feature">
          <div class="feature-icon">💾</div>
          <div class="feature-info">
            <h4>Session History</h4>
            <p>Keep all your sessions, export your data, and review your past performances anytime.</p>
          </div>
        </div>

      </div>
    </div>

    <!-- Final CTA -->
    <div class="trial-cta-section">
      <h3>Ready to Unlock Your Speaking Potential?</h3>
      <p>Join thousands of professionals improving their communication skills with AI Talk Coach.</p>

      <div class="cta-buttons">
        <%= link_to "🚀 Get Full Access", signup_path(trial_token: @trial_session.token),
              class: "btn btn-primary btn-large",
              data: {
                action: "click->analytics#handleSignupClick",
                source: "trial_cta_section"
              } %>
        <%= link_to "🎙️ Try Another Recording", practice_path(trial: true), class: "btn btn-secondary" %>
      </div>
    </div>

  <% end %>
</div>

<style>
.trial-session .trial-badge {
  background: #f59e0b;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 8px;
}

.upgrade-banner {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 24px;
}

.upgrade-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
}

.trial-metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 16px;
}

.trial-metric-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.upgrade-hint {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 8px;
  font-style: italic;
}

.trial-limitation {
  background: #fef3c7;
  border: 1px solid #f59e0b;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  font-size: 0.875rem;
}

.missing-features {
  background: #f8fafc;
  border-radius: 12px;
  padding: 24px;
  margin-top: 32px;
}

.missing-features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.missing-feature {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}

.feature-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.trial-cta-section {
  text-align: center;
  padding: 32px;
  background: white;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  margin-top: 32px;
}

.cta-buttons {
  display: flex;
  gap: 16px;
  justify-content: center;
  margin-top: 20px;
}

.btn-large {
  padding: 12px 24px;
  font-size: 1.1rem;
}

.trial-note {
  background: #fef3c7;
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.875rem;
}
</style>