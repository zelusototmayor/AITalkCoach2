<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "AI Talk Coach" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="AI-powered speech coaching platform to improve your communication skills">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KM66Q2D5T3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KM66Q2D5T3');
    </script>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body data-controller="accessibility analytics feedback-menu" data-analytics-enabled-value="<%= Rails.env.production? %>" data-analytics-debug-value="<%= !Rails.env.production? %>">
    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Accessibility settings panel -->
    <div class="accessibility-panel" data-accessibility-target="panel" data-feedback-menu-target="accessibilityPanel" aria-hidden="true">
      <h2>Accessibility Settings</h2>
      <div class="accessibility-controls">
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleHighContrast"
                aria-pressed="false">
          Toggle High Contrast
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleLargeText"
                aria-pressed="false">
          Toggle Large Text
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleReducedMotion"
                aria-pressed="false">
          Reduce Motion
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleKeyboardNavigation"
                aria-pressed="false">
          Enhanced Keyboard Navigation
        </button>
      </div>
      <button type="button"
              class="close-panel"
              data-action="click->accessibility#closePanel"
              aria-label="Close accessibility panel">
        <%= icon_svg(:x_simple, css_class: 'icon-inline') %>
      </button>
    </div>

    <!-- Feedback modal -->
    <div class="feedback-modal" data-feedback-menu-target="feedbackModal" aria-hidden="true">
      <div class="feedback-modal-content">
        <h2>Share Your Feedback</h2>
        <p class="feedback-description">Help us improve AI Talk Coach by sharing your thoughts or reporting issues.</p>

        <form data-action="submit->feedback-menu#submitFeedback" data-feedback-menu-target="form">
          <div class="form-group">
            <label for="feedback-text">Your Feedback</label>
            <textarea
              id="feedback-text"
              name="feedback_text"
              data-feedback-menu-target="feedbackText"
              placeholder="Tell us what you think, report a bug, or suggest a feature..."
              rows="6"
              maxlength="5000"
              required></textarea>
            <div class="character-count">
              <span data-feedback-menu-target="charCount">0</span> / 5000
            </div>
          </div>

          <div class="form-group">
            <label for="feedback-images">Attach Images (Optional)</label>
            <input
              type="file"
              id="feedback-images"
              name="images"
              data-feedback-menu-target="imageInput"
              data-action="change->feedback-menu#handleImageChange"
              accept="image/*"
              multiple
              class="file-input" />
            <div class="file-input-label">
              <span class="file-icon">ðŸ“Ž</span>
              <span data-feedback-menu-target="fileLabel">Choose images (max 5)</span>
            </div>
            <div class="image-previews" data-feedback-menu-target="imagePreviews"></div>
          </div>

          <div class="feedback-actions">
            <button type="button"
                    class="btn-secondary"
                    data-action="click->feedback-menu#closeFeedbackModal">
              Cancel
            </button>
            <button type="submit"
                    class="btn-primary"
                    data-feedback-menu-target="submitBtn">
              <span data-feedback-menu-target="submitText">Send Feedback</span>
              <span data-feedback-menu-target="submitLoader" class="loader" style="display: none;"></span>
            </button>
          </div>
        </form>

        <button type="button"
                class="close-modal"
                data-action="click->feedback-menu#closeFeedbackModal"
                aria-label="Close feedback modal">
          âœ•
        </button>
      </div>
    </div>

    <!-- Feedback button -->
    <button type="button"
            class="feedback-button"
            data-action="click->feedback-menu#openFeedbackModal"
            aria-label="Share feedback">
      Share Feedback
    </button>

    <% if logged_in? %>
      <!-- Dashboard Layout with Sidebar (for logged-in users) -->
      <div class="app-layout-with-sidebar">
        <%= render 'shared/sidebar' %>

        <% if notice %>
          <div class="flash notice" role="alert" aria-live="polite">
            <span aria-hidden="true"><%= icon_svg(:check, css_class: 'icon-inline') %></span> <%= notice %>
          </div>
        <% end %>

        <% if alert %>
          <div class="flash alert" role="alert" aria-live="assertive">
            <span aria-hidden="true"><%= icon_svg(:alert, css_class: 'icon-inline') %></span> <%= alert %>
          </div>
        <% end %>

        <main class="main-content" id="main-content" role="main" tabindex="-1">
          <%= yield %>
        </main>
      </div>
    <% else %>
      <!-- Marketing Site Layout with Top Navigation (for non-logged-in users) -->
      <header class="main-header" role="banner">
        <nav class="main-nav"
             data-controller="navigation"
             role="navigation"
             aria-label="Main navigation">
          <div class="logo-container">
            <%= link_to marketing_subdomain_url('/'),
                  class: "logo-link",
                  "aria-label" => "AI Talk Coach - Go to homepage" do %>
              <img src="/logo.png" alt="AI Talk Coach" class="logo-image" />
              <span class="logo-text">AI Talk Coach</span>
            <% end %>
          </div>

          <!-- Mobile Menu Toggle -->
          <button type="button"
                  class="mobile-menu-toggle"
                  aria-label="Toggle navigation menu"
                  aria-expanded="false"
                  aria-controls="nav-menu"
                  data-action="click->navigation#toggleMenu"
                  data-navigation-target="toggleButton">
            <span class="hamburger-line" aria-hidden="true"></span>
            <span class="hamburger-line" aria-hidden="true"></span>
            <span class="hamburger-line" aria-hidden="true"></span>
          </button>

          <!-- Navigation Links -->
          <div class="nav-menu" id="nav-menu" data-navigation-target="menu">
            <ul class="nav-links" role="menubar">
              <li class="nav-item" role="none">
                <%= link_to app_subdomain_url('/prompts'),
                      class: "nav-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-icon" aria-hidden="true"><%= icon_svg(:lightbulb, css_class: 'icon-inline') %></span>
                  <span class="nav-text">Prompts</span>
                <% end %>
              </li>
              <li class="nav-item" role="none">
                <button type="button"
                        class="nav-link"
                        role="menuitem"
                        data-action="click->feedback-menu#openAccessibilityPanel click->navigation#closeMenu">
                  <span class="nav-icon" aria-hidden="true"><%= icon_svg(:eye, css_class: 'icon-inline') %></span>
                  <span class="nav-text">Accessibility</span>
                </button>
              </li>
              <li class="nav-item" role="none">
                <%= link_to app_subdomain_url('/privacy_settings'),
                      class: "nav-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-icon" aria-hidden="true"><%= icon_svg(:lock, css_class: 'icon-inline') %></span>
                  <span class="nav-text">Privacy</span>
                <% end %>
              </li>
              <li class="nav-item" role="none">
                <%= link_to app_subdomain_url('/login'),
                      class: "nav-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-icon" aria-hidden="true"><%= icon_svg(:lock, css_class: 'icon-inline') %></span>
                  <span class="nav-text">Login</span>
                <% end %>
              </li>
              <li class="nav-item" role="none">
                <%= link_to app_subdomain_url('/signup'),
                      class: "nav-link signup-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-icon" aria-hidden="true"><%= icon_svg(:sparkles, css_class: 'icon-inline') %></span>
                  <span class="nav-text">Sign Up</span>
                <% end %>
              </li>
            </ul>
          </div>
        </nav>
      </header>

      <% if notice %>
        <div class="flash notice" role="alert" aria-live="polite">
          <span aria-hidden="true"><%= icon_svg(:check, css_class: 'icon-inline') %></span> <%= notice %>
        </div>
      <% end %>

      <% if alert %>
        <div class="flash alert" role="alert" aria-live="assertive">
          <span aria-hidden="true"><%= icon_svg(:alert, css_class: 'icon-inline') %></span> <%= alert %>
        </div>
      <% end %>

      <main class="main-content" id="main-content" role="main" tabindex="-1">
        <%= yield %>
      </main>
    <% end %>
  </body>
</html>
