<!DOCTYPE html>
<html lang="en">
  <head>
    <%= display_meta_tags %>
    <link rel="canonical" href="<%= request.base_url + request.path %>">

    <script type="application/ld+json">
      <%= {
        "@context" => "https://schema.org",
        "@type" => "SoftwareApplication",
        "name" => "AI Talk Coach",
        "applicationCategory" => "EducationalApplication",
        "operatingSystem" => "Web",
        "url" => "https://aitalkcoach.com/",
        "description" => (@meta_tags&.dig(:description).presence || "Master your communication skills with AI-powered speech coaching. Get feedback, track progress, and become a more confident speaker.")
      }.to_json.html_safe %>
    </script>

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KM66Q2D5T3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KM66Q2D5T3');
    </script>

    <!-- Mixpanel Analytics -->
    <script type="text/javascript">
      (function(e,c){if(!c.__SV){var l,h;window.mixpanel=c;c._i=[];c.init=function(q,r,f){function t(d,a){var g=a.split(".");2==g.length&&(d=d[g[0]],a=g[1]);d[a]=function(){d.push([a].concat(Array.prototype.slice.call(arguments,0)))}}var b=c;"undefined"!==typeof f?b=c[f]=[]:f="mixpanel";b.people=b.people||[];b.toString=function(d){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);d||(a+=" (stub)");return a};b.people.toString=function(){return b.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders start_session_recording stop_session_recording people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
      for(h=0;h<l.length;h++)t(b,l[h]);var n="set set_once union unset remove delete".split(" ");b.get_group=function(){function d(p){a[p]=function(){b.push([g,[p].concat(Array.prototype.slice.call(arguments,0))])}}for(var a={},g=["get_group"].concat(Array.prototype.slice.call(arguments,0)),m=0;m<n.length;m++)d(n[m]);return a};c._i.push([q,r,f])};c.__SV=1.2;var k=e.createElement("script");k.type="text/javascript";k.async=!0;k.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===
      e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";e=e.getElementsByTagName("script")[0];e.parentNode.insertBefore(k,e)}})(document,window.mixpanel||[])

      <%
        # Use environment-based token selection
        mixpanel_token = ENV['MIXPANEL_TOKEN'] || '44bf717b1ffcda5744f92721374b15da'
        is_debug = !Rails.env.production?
      %>
      mixpanel.init('<%= mixpanel_token %>', {
        autocapture: true,
        record_sessions_percent: 100,
        api_host: 'https://api-eu.mixpanel.com',
        batch_requests: true,
        debug: <%= is_debug %>,
        verbose: <%= is_debug %>,
        loaded: function(mixpanel) {
          console.log('‚úÖ Mixpanel loaded successfully');
        },
        error_reporter: function(msg, item) {
          console.error('‚ùå Mixpanel error:', msg, item);
        }
      })

      // Start sending batched events
      mixpanel.start_batch_senders();

      console.log('üîß Mixpanel initialization started', {
        environment: '<%= Rails.env %>',
        debug: <%= is_debug %>,
        token: '<%= mixpanel_token[0..7] %>...'
      });
    </script>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body data-controller="accessibility analytics feedback-menu" data-analytics-enabled-value="<%= Rails.env.production? %>" data-analytics-debug-value="<%= !Rails.env.production? %>" data-user-id="<%= current_user ? current_user.id : '' %>" data-user-email="<%= current_user ? current_user.email : '' %>" data-user-name="<%= current_user ? current_user.name : '' %>">
    <!-- Animated Background -->
    <div class="animated-background">
      <div class="wave-layer"></div>
    </div>

    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Accessibility settings panel -->
    <div class="accessibility-panel" data-accessibility-target="panel" data-feedback-menu-target="accessibilityPanel" aria-hidden="true">
      <h2>Accessibility Settings</h2>
      <div class="accessibility-controls">
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleHighContrast"
                aria-pressed="false">
          Toggle High Contrast
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleLargeText"
                aria-pressed="false">
          Toggle Large Text
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleReducedMotion"
                aria-pressed="false">
          Reduce Motion
        </button>
        <button type="button"
                class="accessibility-btn"
                data-action="click->accessibility#toggleKeyboardNavigation"
                aria-pressed="false">
          Enhanced Keyboard Navigation
        </button>
      </div>
      <button type="button"
              class="close-panel"
              data-action="click->accessibility#closePanel"
              aria-label="Close accessibility panel">
        <%= icon_svg(:x_simple, css_class: 'icon-inline') %>
      </button>
    </div>

    <!-- Feedback modal -->
    <div class="feedback-modal" data-feedback-menu-target="feedbackModal" aria-hidden="true">
      <div class="feedback-modal-content">
        <h2>Share Your Feedback</h2>
        <p class="feedback-description">Help us improve AI Talk Coach by sharing your thoughts or reporting issues.</p>

        <form data-action="submit->feedback-menu#submitFeedback" data-feedback-menu-target="form">
          <div class="form-group">
            <label for="feedback-text">Your Feedback</label>
            <textarea
              id="feedback-text"
              name="feedback_text"
              data-feedback-menu-target="feedbackText"
              placeholder="Tell us what you think, report a bug, or suggest a feature..."
              rows="6"
              maxlength="5000"
              required></textarea>
            <div class="character-count">
              <span data-feedback-menu-target="charCount">0</span> / 5000
            </div>
          </div>

          <div class="form-group">
            <label for="feedback-images">Attach Images (Optional)</label>
            <input
              type="file"
              id="feedback-images"
              name="images"
              data-feedback-menu-target="imageInput"
              data-action="change->feedback-menu#handleImageChange"
              accept="image/*"
              multiple
              class="file-input" />
            <label for="feedback-images" class="file-input-label" data-feedback-menu-target="fileInputLabel">
              <span class="file-icon">üìé</span>
              <span data-feedback-menu-target="fileLabel">Choose images (max 5)</span>
            </label>
            <div class="image-previews" data-feedback-menu-target="imagePreviews"></div>
          </div>

          <div class="feedback-actions">
            <button type="button"
                    class="btn-secondary"
                    data-action="click->feedback-menu#closeFeedbackModal">
              Cancel
            </button>
            <button type="submit"
                    class="btn-primary"
                    data-feedback-menu-target="submitBtn">
              <span data-feedback-menu-target="submitText">Send Feedback</span>
              <span data-feedback-menu-target="submitLoader" class="loader" style="display: none;"></span>
            </button>
          </div>
        </form>

        <button type="button"
                class="close-modal"
                data-action="click->feedback-menu#closeFeedbackModal"
                aria-label="Close feedback modal">
          ‚úï
        </button>
      </div>
    </div>

    <!-- Feedback button -->
    <button type="button"
            class="feedback-button"
            data-action="click->feedback-menu#openFeedbackModal"
            aria-label="Share feedback">
      Share Feedback
    </button>

    <% if logged_in? && request.subdomain == 'app' %>
      <!-- Check if user is in onboarding flow -->
      <% in_onboarding = request.path.starts_with?('/onboarding') %>

      <% if in_onboarding %>
        <!-- Onboarding Layout (no sidebar) -->
        <%= render 'shared/flash_messages' %>

        <main class="main-content" id="main-content" role="main" tabindex="-1">
          <%= yield %>
        </main>
      <% else %>
        <!-- Dashboard Layout with Sidebar (for logged-in users on app subdomain) -->
        <div class="app-layout-with-sidebar" data-controller="sidebar">
          <!-- Mobile Sidebar Toggle Button -->
          <button type="button"
                  class="sidebar-mobile-toggle"
                  aria-label="Toggle sidebar navigation"
                  aria-expanded="false"
                  data-action="click->sidebar#toggle"
                  data-sidebar-target="toggleButton">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </button>

          <!-- Sidebar Overlay (for closing sidebar when clicking outside on mobile) -->
          <div class="sidebar-overlay" data-action="click->sidebar#close" data-sidebar-target="overlay"></div>

          <%= render 'shared/sidebar' %>
          <%= render 'shared/flash_messages' %>

          <main class="main-content" id="main-content" role="main" tabindex="-1">
            <%= yield %>
          </main>

          <%# App Tour / Guided Walkthrough %>
          <% if should_show_tour? %>
            <div data-controller="tour"
                 data-tour-name-value="<%= current_tour_name %>"
                 data-tour-steps-value="<%= tour_steps_json(current_tour_name) %>"
                 data-tour-auto-start-value="true">
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <!-- Marketing Site Layout with Top Navigation (for non-logged-in users) -->
      <header class="main-header" role="banner">
        <nav class="main-nav"
             data-controller="navigation"
             role="navigation"
             aria-label="Main navigation">
          <div class="logo-container">
            <%= link_to marketing_subdomain_url('/'),
                  class: "logo-link",
                  "aria-label" => "AI Talk Coach - Go to homepage" do %>
              <img src="/logo.png" alt="AI Talk Coach" class="logo-image" />
              <span class="logo-text">AI Talk Coach</span>
            <% end %>
          </div>

          <!-- Mobile Menu Toggle -->
          <button type="button"
                  class="mobile-menu-toggle"
                  aria-label="Toggle navigation menu"
                  aria-expanded="false"
                  aria-controls="nav-menu"
                  data-action="click->navigation#toggleMenu"
                  data-navigation-target="toggleButton">
            <span class="hamburger-line" aria-hidden="true"></span>
            <span class="hamburger-line" aria-hidden="true"></span>
            <span class="hamburger-line" aria-hidden="true"></span>
          </button>

          <!-- Navigation Links -->
          <div class="nav-menu" id="nav-menu" data-navigation-target="menu">
            <ul class="nav-links" role="menubar">
              <li class="nav-item" role="none">
                <%= link_to marketing_subdomain_url('/'),
                      class: "nav-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-text">Home</span>
                <% end %>
              </li>
              <li class="nav-item" role="none">
                <%= link_to marketing_subdomain_url('/pricing'),
                      class: "nav-link",
                      role: "menuitem",
                      data: { action: "click->navigation#closeMenu" } do %>
                  <span class="nav-text">Pricing</span>
                <% end %>
              </li>

              <% if logged_in? %>
                <!-- Logged-in user menu -->
                <li class="nav-item" role="none">
                  <%= link_to app_subdomain_url('/practice'),
                        class: "nav-link",
                        role: "menuitem",
                        data: { action: "click->navigation#closeMenu" } do %>
                    <span class="nav-text">Go to App</span>
                  <% end %>
                </li>
                <li class="nav-item" role="none">
                  <span class="nav-link user-info" role="menuitem">
                    <span class="nav-text"><%= current_user.name %></span>
                  </span>
                </li>
                <li class="nav-item" role="none">
                  <%= link_to app_subdomain_url('/logout'),
                        class: "nav-link",
                        role: "menuitem",
                        data: {
                          turbo: false,
                          action: "click->navigation#closeMenu"
                        } do %>
                    <span class="nav-text">Log out</span>
                  <% end %>
                </li>
              <% else %>
                <!-- Non-logged-in user menu -->
                <li class="nav-item" role="none">
                  <%= link_to app_subdomain_url('/login'),
                        class: "nav-link",
                        role: "menuitem",
                        data: { action: "click->navigation#closeMenu" } do %>
                    <span class="nav-text">Log in</span>
                  <% end %>
                </li>
                <li class="nav-item" role="none">
                  <%= link_to app_subdomain_url('/signup'),
                        class: "nav-link signup-link",
                        role: "menuitem",
                        data: { action: "click->navigation#closeMenu" } do %>
                    <span class="nav-text">Sign Up</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        </nav>
      </header>

      <%= render 'shared/flash_messages' %>

      <main class="main-content" id="main-content" role="main" tabindex="-1">
        <%= yield %>
      </main>
    <% end %>
  </body>
</html>
